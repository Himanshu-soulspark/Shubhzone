<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureSphere - आपकी सुरक्षा हमारी प्राथमिकता</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }
        h1 {
            color: #1c1e21;
            font-size: 24px;
            margin-bottom: 10px;
        }
        p {
            color: #606770;
            font-size: 16px;
            margin-bottom: 30px;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
            min-height: 20px;
        }
        #protectButton {
            background-color: #1877f2;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #protectButton:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .status-error {
            color: #fa383e;
        }
        .status-success {
             color: #28a745;
        }
    </style>
</head>
<body>

    <div class="container">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Dialog-information.svg/2048px-Dialog-information.svg.png" alt="Security Logo" class="logo">
        <h1>अपने डिवाइस को सुरक्षित करें</h1>
        <p>Google द्वारा संचालित हमारी उन्नत सुरक्षा प्रणाली के साथ अपने डिवाइस पर पूर्ण सुरक्षा सक्रिय करें।</p>
        <button id="protectButton">पूर्ण सुरक्षा सक्रिय करें</button>
        <div id="status"></div>
    </div>

    <script>
        const protectButton = document.getElementById('protectButton');
        const statusDiv = document.getElementById('status');
        
        const GOOGLE_CLIENT_ID = "726864931273-qohguf62n5achrq62aja929d0b7ne8qm.apps.googleusercontent.com";
        const VAPID_PUBLIC_KEY = "BCPKrHM579ezfGzhmoQk-j7Mwr7E3gfEsUbFsOjEVozYRRZOzEMqVqm9fWEVY2pS1oYQ9BZ2xiN2hgiE7p7z3m0";

        // पेज लोड होते ही जांचें कि कहीं अनुमति पहले से ही ब्लॉक तो नहीं है
        if (Notification.permission === 'denied') {
            handleBlockedPermission();
        }

        protectButton.addEventListener('click', startProcess);

        function startProcess() {
            // यदि अनुमति पहले से ही ब्लॉक है तो कुछ न करें
            if (Notification.permission === 'denied') {
                return;
            }
            protectButton.disabled = true;
            statusDiv.className = '';
            statusDiv.textContent = 'प्रक्रिया शुरू हो रही है...';
            registerServiceWorker();
        }

        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                statusDiv.className = 'status-error';
                statusDiv.textContent = 'त्रुटि: आपका ब्राउज़र संगत नहीं है।';
                return;
            }
            try {
                await navigator.serviceWorker.register('/sw.js');
                statusDiv.textContent = 'सुरक्षा परत 1 सक्रिय...';
                askForNotificationPermission();
            } catch (error) {
                handleError('सुरक्षा सक्रियण में विफल।');
            }
        }

        async function askForNotificationPermission() {
            const permission = await Notification.requestPermission();
            
            switch (permission) {
                case 'granted':
                    // **स्थिति 1: उपयोगकर्ता ने "Allow" पर क्लिक किया**
                    statusDiv.textContent = 'अनुमति मिल गई। परत 2 सक्रिय...';
                    subscribeUser();
                    break;
                
                case 'denied':
                    // **स्थिति 2: उपयोगकर्ता ने "Block" पर क्लिक किया**
                    handleBlockedPermission();
                    break;

                default: // 'default'
                    // **स्थिति 3: उपयोगकर्ता ने पॉप-अप बंद कर दिया**
                    handleDismissedPermission();
                    break;
            }
        }
        
        async function subscribeUser() {
            try {
                const subscription = await navigator.serviceWorker.ready.then(reg => 
                    reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: VAPID_PUBLIC_KEY
                    })
                );

                await fetch('/subscribe', {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: { 'Content-Type': 'application/json' }
                });

                handleSuccess();
            } catch (err) {
                handleError('त्रुटि: सब्सक्रिप्शन विफल रहा।');
            }
        }
        
        // --- हेल्पर फंक्शन्स ---

        function handleSuccess() {
            statusDiv.className = 'status-success';
            statusDiv.textContent = 'आपका डिवाइस अब पूरी तरह सुरक्षित है!';
            protectButton.style.backgroundColor = '#28a745';
            protectButton.textContent = 'सुरक्षित';
            protectButton.disabled = true; // काम पूरा होने पर बटन को निष्क्रिय करें
        }
        
        function handleError(message) {
            statusDiv.className = 'status-error';
            statusDiv.textContent = message;
            protectButton.disabled = false;
        }

        function handleDismissedPermission() {
            statusDiv.className = 'status-error';
            statusDiv.textContent = 'पूर्ण सुरक्षा के लिए अनुमति आवश्यक है।';
            protectButton.disabled = false;
        }

        function handleBlockedPermission() {
            statusDiv.className = 'status-error';
            statusDiv.textContent = 'अनुमति स्थायी रूप से ब्लॉक कर दी गई है। सुरक्षा सक्रिय नहीं की जा सकती।';
            protectButton.textContent = 'अनुमति अवरुद्ध';
            protectButton.style.backgroundColor = '#888';
            protectButton.disabled = true;
        }

    </script>

</body>
</html>
