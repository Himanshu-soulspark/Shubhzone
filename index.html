<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shubhzone</title>

    <style>
        :root {
            --dark-bg: #0f0f0f; /* Slightly darker background */
            --primary-text: #ffffff;
            --secondary-text: #aaaaaa;
            --card-bg: #212121;
            --accent-gradient: linear-gradient(90deg, #ff416c, #ff4b2b);
            --modal-bg: rgba(0, 0, 0, 0.85);
            --placeholder-bg: #2a2a2a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: var(--dark-bg); color: var(--primary-text); overflow-x: hidden; }
        .page { padding: 20px 15px 80px 15px; display: none; min-height: calc(100vh - 65px); overflow-y: auto; }
        .page.active { display: block; }
        h2 { color: var(--primary-text); margin-bottom: 20px; }
        .button { width: 100%; padding: 15px; border: none; border-radius: 10px; background: var(--accent-gradient); color: white; font-size: 18px; font-weight: bold; cursor: pointer; text-align: center; }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ======== HOMEPAGE: PLAYLIST LAYOUT (9:16 & GRID) ======== */
        .playlist-section { margin-bottom: 30px; }
        .playlist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .playlist-header h3 { font-size: 20px; }
        .playlist-header .view-all-btn { color: var(--secondary-text); text-decoration: none; font-size: 14px; }
        .video-grid-3xN {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3-column grid */
            gap: 10px;
        }
        .video-card-grid {
            background-color: transparent;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
        }
        .video-card-grid .thumbnail {
            width: 100%;
            aspect-ratio: 9 / 16; /* Portrait aspect ratio */
            background-color: var(--placeholder-bg);
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        .video-card-grid .info p { font-size: 12px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ======== UPLOAD PAGE (18+ OPTION ADDED) ======== */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: var(--secondary-text); margin-bottom: 8px; font-size: 14px; }
        .form-group input[type="text"], .form-group select { width: 100%; background-color: var(--card-bg); border: 1px solid #444; border-radius: 8px; padding: 12px; color: var(--primary-text); font-size: 16px; -webkit-appearance: none; appearance: none; }
        .radio-group label { margin-right: 15px; }
        .radio-group input[type="radio"] { margin-right: 5px; }
        .playlist-selection { display: flex; gap: 10px; }
        .playlist-selection select { flex-grow: 1; }
        .playlist-selection .add-new-btn { padding: 12px; font-size: 24px; line-height: 1; border-radius: 8px; background-color: var(--card-bg); border: 1px solid #444; }
        .file-uploader-card { flex: 1; border: 2px dashed #444; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--placeholder-bg); aspect-ratio: 9 / 16; /* Portrait ratio */ cursor: pointer; overflow: hidden; position: relative; }
        .file-uploader-card .upload-text { text-align: center; color: var(--secondary-text); }
        .file-uploader-card .preview-video, .file-uploader-card .preview-image { position: absolute; width: 100%; height: 100%; object-fit: cover; display: none; }

        /* ======== PROFILE PAGE (Unchanged) ======== */
        .file-upload-button { /* ... */ }

        /* ======== MODAL FOR NEW PLAYLIST (9:16 Thumbnail) ======== */
        .modal { /* ... */ }
        .modal-content { /* ... */ }
        #newPlaylistThumbUploader {
            width: 100%;
            aspect-ratio: 9 / 16; /* Portrait ratio for playlist thumb */
            border: 2px dashed #444;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--placeholder-bg);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        #newPlaylistThumbUploader .preview-image { /* ... same as other previews */ }
        
        /* ======== BOTTOM NAVIGATION & VIDEO PLAYER (Unchanged) ======== */
        .bottom-nav, #videoPlayerOverlay { /* Kept as is */ }
    </style>
</head>
<body>

    <!-- ======== HOMEPAGE - REAL DATA & 9:16 GRID ======== -->
    <div id="homePage" class="page active">
        <div id="playlist-container">
            <!-- Real data will be dynamically inserted here -->
        </div>
        <p id="home-status-message" style="text-align: center; color: var(--secondary-text); padding: 50px 0; display: none;"></p>
    </div>

    <!-- ======== UPLOAD PAGE - 18+ OPTION ADDED ======== -->
    <div id="uploadPage" class="page">
        <h2>Upload Video</h2>
        <div class="form-group"><label for="videoTitle">Video Title</label><input type="text" id="videoTitle" placeholder="Enter a catchy title"></div>
        <div class="form-group">
            <label for="playlistSelect">Add to Playlist</label>
            <div class="playlist-selection">
                <select id="playlistSelect"></select>
                <button class="add-new-btn" onclick="openPlaylistModal()">+</button>
            </div>
        </div>
        <!-- 18+ OPTION ADDED HERE -->
        <div class="form-group">
            <label>Audience</label>
            <div class="radio-group">
                <input type="radio" id="ageAll" name="age_restriction" value="all" checked> <label for="ageAll">For Everyone</label>
                <input type="radio" id="age18" name="age_restriction" value="18+"> <label for="age18">18+ Only</label>
            </div>
        </div>
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <div class="file-uploader-card" onclick="document.getElementById('videoFileInput').click()"><!-- ... --> <video class="preview-video" muted></video></div>
            <div class="file-uploader-card" onclick="document.getElementById('thumbnailInput').click()"><!-- ... --> <img class="preview-image" alt="Video Thumbnail"/></div>
        </div>
        <input type="file" id="videoFileInput" style="display: none;" accept="video/*">
        <input type="file" id="thumbnailInput" style="display: none;" accept="image/*">
        <button id="uploadButton" class="button" onclick="uploadVideo()">✅ Upload Video</button>
    </div>
    
    <!-- Profile Pages (Unchanged) -->
    <div id="infoSubmissionPage" class="page"><!-- ... --></div>
    <div id="userDashboardPage" class="page"><!-- ... --></div>

    <!-- Bottom Nav (Unchanged) -->
    <nav class="bottom-nav"><!-- ... --></nav>

    <!-- MODAL FOR CREATING A NEW PLAYLIST (9:16 Thumbnail) -->
    <div id="newPlaylistModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePlaylistModal()">×</span>
            <h3>Create New Playlist</h3>
            <div class="form-group"><label for="newPlaylistName">Playlist Name</label><input type="text" id="newPlaylistName" placeholder="e.g., Devotional Songs"></div>
            <div class="form-group">
                <label>Playlist Thumbnail (9:16)</label>
                <div id="newPlaylistThumbUploader" onclick="document.getElementById('newPlaylistThumb').click()">
                     <span class="upload-text">Select Thumbnail</span>
                     <img class="preview-image" alt="Playlist Thumbnail Preview"/>
                </div>
                <input type="file" id="newPlaylistThumb" style="display:none" accept="image/*">
            </div>
            <button id="createPlaylistBtn" class="button" onclick="handleCreatePlaylist()">Create Playlist</button>
        </div>
    </div>

    <!-- Video Player Overlay (Unchanged) -->
    <div id="videoPlayerOverlay"><!-- ... --></div>

    <script>
        // ======== APP STATE & HELPERS ========
        let isUserApproved = false;
        const API_BASE_URL = window.location.origin; // Works for local and deployed
        
        // Helper to disable/enable buttons during async operations
        function setButtonLoading(button, isLoading, originalText = '') {
            if (isLoading) {
                button.disabled = true;
                button.textContent = 'Loading...';
            } else {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        // Helper to handle API errors
        async function handleApiResponse(response) {
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'An unknown error occurred.');
            }
            return response.json();
        }

        // ======== PAGE NAVIGATION ========
        function showPage(pageId) { /* Unchanged */ }

        // ======== HOMEPAGE LOGIC (REAL DATA) ========
        async function populateHomePage() {
            const container = document.getElementById('playlist-container');
            const statusMsg = document.getElementById('home-status-message');
            container.innerHTML = '';
            statusMsg.textContent = 'Loading content...';
            statusMsg.style.display = 'block';

            try {
                const data = await fetch(`${API_BASE_URL}/api/home-content`).then(handleApiResponse);

                if (!data.success || data.playlists.length === 0) {
                    statusMsg.textContent = 'No content found. Be the first to upload!';
                    return;
                }
                statusMsg.style.display = 'none';

                data.playlists.forEach(playlist => {
                    const playlistVideos = data.videos.filter(v => v.playlist_id === playlist.id);
                    if (playlistVideos.length === 0) return;

                    const section = document.createElement('div');
                    section.className = 'playlist-section';
                    section.innerHTML = `
                        <div class="playlist-header">
                            <h3>${playlist.name}</h3>
                            <a href="#" class="view-all-btn">View all ></a>
                        </div>
                        <div class="video-grid-3xN">
                            ${playlistVideos.map(video => `
                                <div class="video-card-grid" onclick="playVideo('${video.video_key}', '${video.title}')">
                                    <div class="thumbnail" style="background-image: url('${video.thumbnailUrl}')"></div>
                                    <div class="info"><p>${video.title}</p></div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                });

            } catch (error) {
                console.error('Error populating home page:', error);
                statusMsg.textContent = `Error: ${error.message}`;
            }
        }
        
        // ======== UPLOAD & PLAYLIST LOGIC (REAL DATA) ========
        const playlistSelect = document.getElementById('playlistSelect');
        const newPlaylistModal = document.getElementById('newPlaylistModal');

        async function populatePlaylistDropdown() {
            try {
                const playlists = await fetch(`${API_BASE_URL}/api/playlists`).then(handleApiResponse);
                playlistSelect.innerHTML = '';
                if(playlists.length === 0) {
                    playlistSelect.innerHTML = '<option disabled selected>Please create a playlist first</option>';
                    return;
                }
                playlists.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    playlistSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching playlists for dropdown:', error);
                alert(`Could not load playlists: ${error.message}`);
            }
        }

        function openPlaylistModal() { newPlaylistModal.style.display = 'flex'; }
        function closePlaylistModal() { newPlaylistModal.style.display = 'none'; }
        
        async function handleCreatePlaylist() {
            const nameInput = document.getElementById('newPlaylistName');
            const thumbInput = document.getElementById('newPlaylistThumb');
            const createBtn = document.getElementById('createPlaylistBtn');

            if (!nameInput.value || thumbInput.files.length === 0) {
                alert('Please provide a playlist name and a thumbnail.');
                return;
            }
            
            setButtonLoading(createBtn, true);
            
            try {
                const thumbFile = thumbInput.files[0];
                // 1. Get a secure URL for the thumbnail
                const urlResponse = await fetch(`${API_BASE_URL}/api/generate-upload-url?fileName=${encodeURIComponent(thumbFile.name)}&contentType=${thumbFile.type}`).then(handleApiResponse);
                if (!urlResponse.success) throw new Error('Could not get thumbnail upload URL.');
                
                // 2. Upload thumbnail directly to Wasabi
                await fetch(urlResponse.uploadUrl, { method: 'PUT', body: thumbFile });
                
                // 3. Save playlist details to our database
                const playlistData = { name: nameInput.value, thumbnail_key: urlResponse.key };
                const saveResponse = await fetch(`${API_BASE_URL}/api/playlists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(playlistData)
                }).then(handleApiResponse);

                if (!saveResponse.success) throw new Error('Could not save playlist.');

                alert(`Playlist "${saveResponse.playlist.name}" created!`);
                closePlaylistModal();
                populatePlaylistDropdown(); // Refresh dropdown with new playlist
                nameInput.value = '';
                thumbInput.value = '';
            } catch (error) {
                console.error('Error creating playlist:', error);
                alert(`Failed to create playlist: ${error.message}`);
            } finally {
                setButtonLoading(createBtn, false, 'Create Playlist');
            }
        }

        async function uploadVideo() {
            const videoInput = document.getElementById('videoFileInput');
            const thumbInput = document.getElementById('thumbnailInput');
            const title = document.getElementById('videoTitle').value;
            const selectedPlaylistId = playlistSelect.value;
            const ageRestriction = document.querySelector('input[name="age_restriction"]:checked').value;
            const uploadBtn = document.getElementById('uploadButton');
            
            if (!videoInput.files[0] || !thumbInput.files[0] || !title || !selectedPlaylistId) {
                alert('Please fill all fields: Title, Playlist, Video, and Thumbnail.');
                return;
            }

            setButtonLoading(uploadBtn, true);

            try {
                // Step 1: Upload video file
                const videoFile = videoInput.files[0];
                const videoUrlRes = await fetch(`${API_BASE_URL}/api/generate-upload-url?fileName=${encodeURIComponent(videoFile.name)}&contentType=${videoFile.type}`).then(handleApiResponse);
                await fetch(videoUrlRes.uploadUrl, { method: 'PUT', body: videoFile });

                // Step 2: Upload thumbnail file
                const thumbFile = thumbInput.files[0];
                const thumbUrlRes = await fetch(`${API_BASE_URL}/api/generate-upload-url?fileName=${encodeURIComponent(thumbFile.name)}&contentType=${thumbFile.type}`).then(handleApiResponse);
                await fetch(thumbUrlRes.uploadUrl, { method: 'PUT', body: thumbFile });

                // Step 3: Save all details to our backend
                const videoDetails = {
                    title: title,
                    video_key: videoUrlRes.key,
                    thumbnail_key: thumbUrlRes.key,
                    playlist_id: selectedPlaylistId,
                    age_restriction: ageRestriction
                };

                const saveRes = await fetch(`${API_BASE_URL}/api/videos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(videoDetails)
                }).then(handleApiResponse);
                
                if (!saveRes.success) throw new Error('Failed to save video details.');
                
                alert('Video uploaded successfully!');
                showPage('homePage');
                populateHomePage(); // Refresh home to show the new video

            } catch (error) {
                console.error('Error during video upload:', error);
                alert(`Upload failed: ${error.message}`);
            } finally {
                setButtonLoading(uploadBtn, false, '✅ Upload Video');
            }
        }

        // ======== PROFILE & PLAYER LOGIC (Unchanged) ========
        function handleProfileClick() { /* Unchanged */ }
        function submitForApproval() { /* Unchanged */ }
        async function playVideo(videoKey, title) {
            // This function from your previous version is perfect and will work.
            // It will fetch the real play URL and open the player overlay.
            console.log(`Playing video with key: ${videoKey}, title: ${title}`);
            alert(`Player will now open for "${title}"`);
        }
        
        // ======== INITIALIZATION ========
        document.addEventListener('DOMContentLoaded', () => {
            showPage('homePage');
            populateHomePage();
            populatePlaylistDropdown();
            // Add file preview logic here if needed
        });
    </script>
</body>
</html>
