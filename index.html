<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raksha Sutra</title>
    <style>
        /* --- Google Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Tiro+Devanagari+Hindi:wght@400&family=Poppins:wght@400;600;700&display=swap');

        /* --- CSS Variables --- */
        :root {
            --primary-color: #e94d6e;
            --secondary-color: #f06595;
            --text-color: #34495e;
            --light-text-color: #f0f0f0;
            --card-bg: rgba(255, 255, 255, 0.4);
            --blur-effect: blur(10px);
        }

        /* --- General Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }

        body {
            font-family: 'Poppins', sans-serif;
            background: url('https://i.imgur.com/OfaHTgG.jpg') no-repeat center center/cover;
            overflow: hidden;
            color: var(--text-color);
        }
        
        /* --- Page Container --- */
        .page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.7s ease-in-out, transform 0.7s ease-in-out;
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }

        .page.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        /* --- Landing Page --- */
        #landing-page .title {
            font-family: 'Tiro Devanagari Hindi', serif;
            font-size: clamp(2.8rem, 8vw, 4.5rem);
            color: #fff;
            text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        .video-card {
            position: relative;
            width: 90vw;
            max-width: 600px;
            aspect-ratio: 16 / 9;
            background: var(--card-bg);
            backdrop-filter: var(--blur-effect);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .video-card video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .subtitle { margin-top: 25px; font-size: clamp(0.9rem, 2.5vw, 1.1rem); color: var(--light-text-color); max-width: 600px; text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.5); padding: 0 15px; }

        .cta-button {
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50px;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 10px 25px rgba(233, 77, 110, 0.4);
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        .cta-button:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(233, 77, 110, 0.5); }
        .cta-button:disabled { background: #ccc; cursor: not-allowed; }

        /* --- Speaker Icon --- */
        #speaker-icon { position: fixed; top: 20px; right: 20px; font-size: 1.8rem; color: white; cursor: pointer; z-index: 1000; text-shadow: 2px 2px 5px rgba(0,0,0,0.4); }

        /* --- Form & Profile Page --- */
        .form-container { width: 90%; max-width: 450px; padding: 40px 30px; background: var(--card-bg); backdrop-filter: var(--blur-effect); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); }
        .form-container h2 { font-family: 'Poppins', serif; font-size: 2rem; color: var(--text-color); margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; position: relative;}
        .input-field { width: 100%; padding: 15px; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; background-color: rgba(255,255,255,0.7); font-size: 1rem; color: var(--text-color); }
        .back-link { display: inline-block; margin-top: 15px; color: var(--text-color); text-decoration: none; font-weight: 600; }
        
        /* --- NEW: Redesigned Home Page --- */
        #home-page {
            justify-content: space-evenly;
            padding: 20px;
        }
        .home-header {
            font-family: 'Tiro Devanagari Hindi', serif;
            font-size: clamp(2.5rem, 7vw, 3.5rem);
            color: #fff;
            text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.6);
        }
        .home-cards-container {
            display: flex;
            gap: 15px;
            width: 100%;
            max-width: 500px;
            justify-content: center;
        }
        .home-main-card {
            width: 48%;
            aspect-ratio: 2 / 2.5;
            background-size: cover;
            background-position: center;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .home-main-card:hover { transform: scale(1.05); }
        .home-main-card .card-label {
            width: 100%;
            padding: 12px 10px;
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .home-footer-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 450px;
        }
        .footer-button {
            width: 100%;
            padding: 18px 25px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .footer-button:hover {
             background: rgba(0, 0, 0, 0.5);
             transform: translateY(-3px);
        }
        
        /* --- Profile Page --- */
        #profile-page .profile-info { text-align: left; width: 100%; }
        #profile-page .profile-info p { margin-bottom: 20px; color: var(--text-color); font-weight: 600; }
        #profile-page .profile-info span { font-weight: 400; word-break: break-all; background: rgba(0,0,0,0.2); padding: 5px 8px; border-radius: 8px; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); }

        /* --- Main Interface Page --- */
        #main-interface-page { justify-content: center; }
        .dual-card-layout {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 90vw;
            margin-bottom: 30px;
        }
        .interface-card {
            width: 45%;
            max-width: 350px;
            aspect-ratio: 9 / 16;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            border: 2px solid rgba(255,255,255,0.5);
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
        }
        .video-card-main video { width: 100%; height: 100%; object-fit: cover; }
        .message-card-main {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            text-align: left;
        }
        .date-display {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            background: rgba(233, 77, 110, 0.7);
            padding: 5px 15px;
            border-radius: 12px;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
            font-weight: 600;
            z-index: 5;
            white-space: nowrap;
        }
        #main-interface-message {
            color: white;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.7);
            font-size: clamp(0.8rem, 1.8vw, 1rem);
            line-height: 1.6;
            white-space: pre-wrap;
        }
        #replay-speech-btn {
            font-size: 1.6rem;
            cursor: pointer;
            color: white;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
            padding: 8px;
            position: absolute;
            bottom: 15px;
            right: 15px;
            transition: transform 0.2s;
        }
        #replay-speech-btn:hover { transform: scale(1.1); }
        .mystery-box {
            font-size: 4rem;
            background: none;
            border: none;
            cursor: pointer;
            animation: pulse 2s infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.6);
        }
        .mystery-box span {
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            margin-top: 10px;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @media (max-width: 768px) {
            .dual-card-layout { flex-direction: column; gap: 25px; margin-bottom: 25px; }
            .interface-card { width: 70vw; max-width: 300px; height: 35vh; }
        }

        /* --- Falling Flowers Animation --- */
        #falling-elements-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; }
        .falling-element { position: absolute; top: -50px; animation: fall linear infinite; font-size: 1.5rem; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

        /* --- Shared Message Viewer --- */
        #shared-message-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: none; 
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #shared-message-viewer.visible { display: flex; opacity: 1; }
        #shared-message-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            color: var(--text-color);
            font-size: 1.2rem;
            line-height: 1.7;
            text-align: center;
            white-space: pre-wrap;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        #message-display-card {
            width: 100%; min-height: 250px; padding: 25px; background: rgba(255,255,255,0.7); border-radius: 15px; font-size: 1.1rem; line-height: 1.6; color: var(--text-color); display: flex; align-items: center; justify-content: center; text-align: center; margin-bottom: 20px; white-space: pre-wrap;
        }
    </style>
</head>
<body>

<audio id="background-audio" loop><source src="3.m4a" type="audio/mp4"></audio>
<div id="speaker-icon">🔇</div>

<div id="shared-message-viewer">
    <div id="shared-message-content"></div>
</div>

<!-- Page 1: Landing Page -->
<div id="landing-page" class="page active">
    <h1 class="title">Raksha Sutra</h1>
    <div class="video-card"><video autoplay loop muted playsinline><source src="Generated File August 07, 2025 - 7_34PM.mp4" type="video/mp4"></video></div>
    <p class="subtitle">"रक्षाबंधन सिर्फ एक धागा नहीं, बल्कि दिलों का एक अटूट बंधन है।<br>आइए इस रिश्ते को फिर से महसूस करें, एक प्यार भरी डिजिटल राखी के साथ।"</p>
    <button id="get-started-btn" class="cta-button">शुरू करें</button>
</div>

<!-- Page 2: Info Form Page -->
<div id="form-page" class="page">
    <div class="form-container">
        <h2>अपनी जानकारी भरें</h2>
        <form id="info-form">
            <div class="input-group"><input type="text" id="name" class="input-field" placeholder="पूरा नाम" required></div>
            <div class="input-group"><input type="tel" id="phone" class="input-field" placeholder="मोबाइल नंबर (यह आपकी पहचान होगी)" required></div>
            <div class="input-group"><textarea id="address" rows="3" class="input-field" placeholder="पूरा पता" required></textarea></div>
            <button type="submit" class="cta-button">सबमिट करें</button>
        </form>
    </div>
</div>

<!-- Page 3: Main Interface Page -->
<div id="main-interface-page" class="page">
    <div id="falling-elements-container"></div>
    <div class="dual-card-layout">
        <div class="interface-card video-card-main">
            <video playsinline autoplay loop muted id="main-video-player">
                <source src="main interfacemp4.mp4" type="video/mp4">
            </video>
        </div>
        <div class="interface-card message-card-main">
            <div class="date-display">शनिवार, 9 अगस्त, 2025</div>
            <div id="main-interface-message"></div>
            <div id="replay-speech-btn">🔊</div>
        </div>
    </div>
    <button id="mystery-box-btn" class="mystery-box">
        🎁
        <span>मिस्ट्री बॉक्स</span>
    </button>
</div>

<!-- Page 4: Home Page (NEW DESIGN) -->
<div id="home-page" class="page">
    <h1 class="home-header">रक्षा सूत्र</h1>
    <div class="home-cards-container">
        <div id="open-message-creator-btn" class="home-main-card" style="background-image: url('https://i.imgur.com/uJmYf4L.jpeg');">
            <div class="card-label">संदेश भेजें</div>
        </div>
        <div id="open-card-creator-btn" class="home-main-card" style="background-image: url('https://i.imgur.com/k2gUa2d.jpeg');">
            <div class="card-label">कार्ड बनाएं</div>
        </div>
    </div>
    <div class="home-footer-buttons">
        <div id="my-profile-strip" class="footer-button">मेरी प्रोफाइल</div>
        <div id="change-music-strip" class="footer-button">संगीत बदलें</div>
        <div id="whatsapp-share-strip" class="footer-button">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF" style="vertical-align: middle;"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M.05 22c.12-.59.25-1.18.41-1.76l.09-.32c.31-1.09.7-2.14 1.18-3.15.53-1.12 1.16-2.19 1.88-3.18.82-1.1 1.74-2.1 2.76-3 .2-.18.4-.36.6-.53l.4-.33c.53-.44 1.1-.82 1.7-1.14.99-.53 2.03-.9 3.1-1.1.33-.07.67-.12 1.01-.16.29-.03.59-.05.88-.05.23 0 .46.01.69.03.37.03.74.08 1.1.15.99.19 1.94.55 2.83 1.06.88.5 1.69 1.14 2.41 1.89s1.25 1.53 1.75 2.41c.45.83.78 1.71 1 2.62.22.91.31 1.85.28 2.79-.03.95-.2 1.89-.51 2.79-.31.9-.76 1.76-1.33 2.55-.57.79-1.25 1.5-2.02 2.11-.78.6-1.63 1.1-2.54 1.49-.91.38-1.88.64-2.86.76-.98.12-1.97.1-2.95-.05-.98-.15-1.95-.44-2.88-.86a12.926 12.926 0 01-2.7-1.48c-.24-.13-.47-.27-.7-.41l-1.68-1.02c-.55-.33-1.1-.68-1.64-1.05-.1-.07-.2-.14-.3-.21l-.06-.05c-.62-.48-1.2-1-1.73-1.57-.49-.52-.93-1.08-1.32-1.68-.3-.46-.55-.95-.77-1.45l-.02-.06c-.25-.56-.47-1.14-.65-1.73l-.04-.13c-.22-.72-.39-1.46-.5-2.22-.05-.33-.08-.67-.1-1H.05zM9.3 8.35c.14-.38.33-.74.58-1.06.25-.32.55-.6.88-.82.34-.22.7-.4 1.08-.52s.78-.18 1.18-.18c.39 0 .78.04 1.15.13.37.09.73.23 1.06.41.33.18.64.41.91.68.27.27.5.58.68.91.18.33.31.69.4 1.06.09.37.13.76.13 1.15s-.04.78-.13 1.15c-.09.37-.22.73-.4 1.06-.18.33-.41.64-.68.91-.27.27-.58.5-.91.68-.33.18-.69.32-1.06.41-.37-.09-.76.13-1.15.13s-.78-.04-1.15-.13c-.37-.09-.73-.23-1.06-.41-.33-.18-.64-.41-.91-.68-.27-.27-.5-.58-.68-.91-.18-.33-.31-.69-.4-1.06-.09-.37-.13-.76-.13-1.15s.05-.78.14-1.15z"/></svg>
            <span>ऐप शेयर करें</span>
        </div>
    </div>
</div>

<!-- Page 5: My Profile Page -->
<div id="profile-page" class="page">
    <div class="form-container">
        <h2>मेरी प्रोफाइल</h2>
        <div class="profile-info">
            <p>आपका नाम:</p>
            <div class="input-group"><input type="text" id="profile-name-input" class="input-field" placeholder="आपका नाम" required></div>
            <p>आपका पता:</p>
            <div class="input-group"><textarea id="profile-address-input" class="input-field" placeholder="आपका पता" rows="3" required></textarea></div>
            <p>आपकी आईडी: <span id="profile-call-id">रजिस्टर्ड नहीं है</span></p>
        </div>
        <button id="update-profile-btn" class="cta-button">प्रोफाइल अपडेट करें</button>
        <a href="#" class="back-link" data-target="home-page">वापस जाएं</a>
    </div>
</div>

<!-- Page 6: Music Change Page -->
<div id="music-page" class="page">
     <div class="form-container">
        <h2>संगीत बदलें</h2>
        <button class="cta-button music-btn" data-src="1.m4a">रक्षा सूत्र संगीत 1</button>
        <button class="cta-button music-btn" data-src="2.m4a">रक्षा सूत्र संगीत 2</button>
        <button class="cta-button music-btn" data-src="3.m4a">रक्षा सूत्र संगीत 3</button>
        <a href="#" class="back-link" data-target="home-page">वापस जाएं</a>
    </div>
</div>

<!-- Page 7: Pre-made Message Creator Page -->
<div id="message-creator-page" class="page">
    <div class="form-container">
        <h2 id="message-creator-title">एक संदेश बनाएं</h2>
        <button id="bhai-to-bhen-btn" class="cta-button" style="width:100%; margin-bottom: 15px;">भाई की तरफ से बहन के लिए</button>
        <button id="bhen-to-bhai-btn" class="cta-button" style="width:100%;">बहन की तरफ से भाई के लिए</button>
         <a href="#" class="back-link" data-target="home-page">वापस जाएं</a>
    </div>
</div>

<!-- Page 8: Name Input for Messages -->
<div id="message-name-form-page" class="page">
    <div class="form-container">
        <h2 id="message-name-title">नाम दर्ज करें</h2>
        <form id="message-name-form">
            <div class="input-group"><input type="text" id="sender-name" class="input-field" placeholder="आपका नाम" required></div>
            <div class="input-group"><input type="text" id="receiver-name" class="input-field" placeholder="भाई/बहन का नाम" required></div>
            <button type="submit" class="cta-button">संदेश देखें</button>
        </form>
        <a href="#" class="back-link" data-target="message-creator-page">वापस जाएं</a>
    </div>
</div>

<!-- Page 9: Message Display Page -->
<div id="message-display-page" class="page">
     <div class="form-container">
        <h2>आपके लिए एक प्यारा संदेश</h2>
        <div id="message-display-card"></div>
        <p style="color: #555; margin-top: 15px; font-style: italic;">अगला संदेश देखने के लिए दाएं या बाएं स्वाइप करें</p>
        <button id="whatsapp-share-message-btn" class="cta-button" style="margin-top: 20px; background: #25D366;">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF" style="vertical-align: middle; margin-right: 8px;"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M.05 22c.12-.59.25-1.18.41-1.76l.09-.32c.31-1.09.7-2.14 1.18-3.15.53-1.12 1.16-2.19 1.88-3.18.82-1.1 1.74-2.1 2.76-3 .2-.18.4-.36.6-.53l.4-.33c.53-.44 1.1-.82 1.7-1.14.99-.53 2.03-.9 3.1-1.1.33-.07.67-.12 1.01-.16.29-.03.59-.05.88-.05.23 0 .46.01.69.03.37.03.74.08 1.1.15.99.19 1.94.55 2.83 1.06.88.5 1.69 1.14 2.41 1.89s1.25 1.53 1.75 2.41c.45.83.78 1.71 1 2.62.22.91.31 1.85.28 2.79-.03.95-.2 1.89-.51 2.79-.31.9-.76 1.76-1.33 2.55-.57.79-1.25 1.5-2.02 2.11-.78.6-1.63 1.1-2.54 1.49-.91.38-1.88.64-2.86.76-.98.12-1.97.1-2.95-.05-.98-.15-1.95-.44-2.88-.86a12.926 12.926 0 01-2.7-1.48c-.24-.13-.47-.27-.7-.41l-1.68-1.02c-.55-.33-1.1-.68-1.64-1.05-.1-.07-.2-.14-.3-.21l-.06-.05c-.62-.48-1.2-1-1.73-1.57-.49-.52-.93-1.08-1.32-1.68-.3-.46-.55-.95-.77-1.45l-.02-.06c-.25-.56-.47-1.14-.65-1.73l-.04-.13c-.22-.72-.39-1.46-.5-2.22-.05-.33-.08-.67-.1-1H.05zM9.3 8.35c.14-.38.33-.74.58-1.06.25-.32.55-.6.88-.82.34-.22.7-.4 1.08-.52s.78-.18 1.18-.18c.39 0 .78.04 1.15.13.37.09.73.23 1.06.41.33.18.64.41.91.68.27.27.5.58.68.91.18.33.31.69.4 1.06.09.37.13.76.13 1.15s-.04.78-.13 1.15c-.09.37-.22.73-.4 1.06-.18.33-.41.64-.68.91-.27.27-.58.5-.91.68-.33.18-.69.32-1.06.41-.37-.09-.76.13-1.15.13s-.78-.04-1.15-.13c-.37-.09-.73-.23-1.06-.41-.33-.18-.64-.41-.91-.68-.27-.27-.5-.58-.68-.91-.18-.33-.31-.69-.4-1.06-.09-.37-.13-.76-.13-1.15s.05-.78.14-1.15z"/></svg>
            <span>संदेश शेयर करें</span>
        </button>
        <a href="#" class="back-link" data-target="message-name-form-page">वापस जाएं</a>
    </div>
</div>

<!-- Page 10: Card Message Input Page -->
<div id="card-message-input-page" class="page">
    <div class="form-container">
        <h2>अपना संदेश लिखें</h2>
        <div class="input-group">
            <textarea id="card-wish-input" class="input-field" placeholder="यहां अपनी शुभकामना लिखें..." required rows="5"></textarea>
        </div>
        <button id="go-to-editor-btn" class="cta-button">इमेज बनाएं</button>
        <a href="#" class="back-link" data-target="home-page">वापस जाएं</a>
    </div>
</div>

<!-- Page 11: Card Editor Page -->
<div id="card-editor-page" class="page">
    <div class="editor-header">
        <button id="editor-back-btn" class="editor-btn">वापस</button>
        <a id="editor-download-btn" class="editor-btn download-btn" href="#" download="rakhi-wish.png">डाउनलोड</a>
    </div>
    <canvas id="editor-canvas"></canvas>
    <div id="card-gallery" class="card-gallery-container"></div>
</div>


<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyB2PG5JvDko2UmQDlY9gN5lBgga2vQy-Ws",
        authDomain: "conceptra-c1000.firebaseapp.com",
        databaseURL: "https://conceptra-c1000-default-rtdb.firebaseio.com",
        projectId: "conceptra-c1000",
        storageBucket: "conceptra-c1000.firebasestorage.app",
        messagingSenderId: "298402987968",
        appId: "1:298402987968:web:c0d0d7d6c08cdfa6bc5225",
        measurementId: "G-QRQYEVSJJ6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const pages = document.querySelectorAll('.page');
    const audio = document.getElementById('background-audio');
    const speakerIcon = document.getElementById('speaker-icon');
    let fallingElementsInterval;
    let currentShareId = null;
    
    let messageType = ''; 
    let currentMessageIndex = 0;
    const messages = {
        'bhai-to-bhen': ["मेरी प्यारी बहना, यह राखी का धागा सिर्फ एक धागा नहीं, बल्कि मेरे प्यार और सुरक्षा का वादा है। रक्षाबंधन की बहुत-बहुत बधाई!", "बचपन की वो खट्टी-मीठी यादें आज भी चेहरे पर मुस्कान ले आती हैं। तुम्हारा होना मेरे जीवन का सबसे बड़ा तोहफा है। हैप्पी रक्षाबंधन!", "तुम सिर्फ मेरी बहन नहीं, मेरी सबसे अच्छी दोस्त भी हो। हर मुश्किल में मेरा साथ देने के लिए धन्यवाद। ईश्वर तुम्हें दुनिया की सारी खुशियाँ दे।", "चाहे हम कितने भी दूर क्यों न हों, इस राखी के दिन मेरा मन हमेशा तुम्हारे पास होता है। तुम्हारा भाई हमेशा तुम्हारे साथ है। हैप्पी राखी!", "आज का दिन बहुत खास है, क्योंकि यह दिन हमारे प्यारे रिश्ते का प्रतीक है। मैं प्रार्थना करता हूँ कि हमारा यह बंधन हमेशा ऐसे ही मजबूत बना रहे।", "मेरी शरारतों को सहने वाली और मुझे हमेशा सही रास्ता दिखाने वाली मेरी प्यारी बहना को रक्षाबंधन की हार्दिक शुभकामनाएँ।", "तुम्हारी राखी मेरी कलाई पर एक कवच की तरह है, जो मुझे हर मुश्किल से लड़ने की ताकत देती है। हमेशा खुश रहो, बहना।", "यह सिर्फ एक धागा नहीं है, यह हमारा अटूट विश्वास और प्यार है। भगवान करे, हमारे रिश्ते की यह मिठास कभी कम न हो।", "तुम मेरे जीवन की प्रेरणा हो। तुम्हारी हंसी मेरे लिए सबसे कीमती है। रक्षाबंधन के इस पावन पर्व पर तुम्हें ढेर सारा प्यार।", "हर साल की तरह इस साल भी मैं वादा करता हूँ कि तुम्हारे हर सुख-दुख में तुम्हारा साथ दूंगा। लव यू बहना, हैप्पी रक्षाबंधन!"],
        'bhen-to-bhai': ["मेरे प्यारे भाई, तुम्हारी कलाई पर यह राखी बांधकर मैं भगवान से तुम्हारी लंबी उम्र और सफलता की कामना करती हूँ। रक्षाबंधन की शुभकामनाएँ!", "तुम मेरे पहले दोस्त और मेरे सुपरहीरो हो। मुझे हमेशा सुरक्षित महसूस कराने के लिए धन्यवाद। हैप्पी राखी भैया!", "हमारा रिश्ता नोक-झोंक और ढेर सारे प्यार से भरा है। भगवान हमारे इस अनोखे बंधन को हमेशा सलामत रखे। हैप्पी रक्षाबंधन।", "दूर होकर भी तुम हमेशा मेरे दिल के करीब हो। यह राखी मेरा प्यार और आशीर्वाद तुम तक पहुंचाएगी। बहुत याद आती है, भाई।", "बचपन से लेकर आज तक, तुमने हमेशा एक बड़े भाई का फर्ज निभाया है। तुम्हारे जैसा भाई पाकर मैं बहुत भाग्यशाली हूँ।", "यह राखी का धागा तुम्हें हर बुरी नजर से बचाए और तुम्हारे जीवन में खुशियों के नए रंग भरे। सदा खुश रहो, मेरे प्यारे भाई।", "जब भी मुझे किसी सहारे की जरूरत पड़ी, मैंने तुम्हें अपने पास पाया। तुम दुनिया के सबसे अच्छे भाई हो। रक्षाबंधन मुबारक!", "तुम्हारी सफलता और खुशी ही मेरी सबसे बड़ी इच्छा है। यह राखी का त्योहार तुम्हारे लिए ढेर सारी सौगातें लेकर आए।", "याद है कैसे हम छोटी-छोटी बातों पर लड़ते थे? आज वो पल बहुत याद आते हैं। हमारा प्यार हमेशा ऐसा ही बना रहे। हैप्पी राखी!", "मेरे प्यारे भाई, तुम मेरी ताकत और मेरा अभिमान हो। ईश्वर तुम्हें जीवन में वह सब कुछ दे जिसके तुम हकदार हो। रक्षाबंधन की बधाई!"]
    };

    function generateShareId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 4; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    async function handleSharedMessage() {
        const urlParams = new URLSearchParams(window.location.search);
        const shareId = urlParams.get('shareId');

        if (shareId && shareId.length === 4) {
            try {
                const messagesRef = collection(db, "sharedMessages");
                const q = query(messagesRef, where("shareId", "==", shareId));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const docData = querySnapshot.docs[0].data();
                    const messageText = docData.fullMessage;
                    
                    const viewer = document.getElementById('shared-message-viewer');
                    const contentDiv = document.getElementById('shared-message-content');
                    
                    contentDiv.textContent = messageText;
                    viewer.classList.add('visible');

                    setTimeout(() => {
                        viewer.classList.remove('visible');
                        window.history.replaceState({}, document.title, window.location.pathname);
                        showPage('landing-page');
                    }, 4000);
                    return true; // Indicate that a shared message was handled
                }
            } catch (error) {
                console.error("Error fetching shared message: ", error);
            }
        }
        return false; // No shared message was handled
    }

    async function loadProfileForEditing() {
        const userId = localStorage.getItem('rakshaSutraUserId');
        if (!userId) {
            showPage('form-page');
            return;
        }
        document.getElementById('profile-call-id').textContent = userId;
        try {
            const userDocRef = doc(db, "users", userId);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const userData = docSnap.data();
                document.getElementById('profile-name-input').value = userData.name || '';
                document.getElementById('profile-address-input').value = userData.address || '';
            } else {
                localStorage.clear();
                showPage('form-page');
            }
        } catch (error) {
            console.error("Error getting document:", error);
        }
    }

    function showPage(pageId) {
        pages.forEach(p => p.classList.remove('active'));
        const page = document.getElementById(pageId);
        if (page) page.classList.add('active');

        if (pageId === 'main-interface-page') {
             startFallingElements();
             document.getElementById('main-video-player').play().catch(()=>{});
        }
        
        if (pageId === 'profile-page') {
            loadProfileForEditing();
        }
    }

    function toggleMusic() {
        if (audio.paused) {
            audio.play().then(() => { speakerIcon.textContent = '🔊'; }).catch(() => {});
        } else {
            audio.pause();
            speakerIcon.textContent = '🔇';
        }
    }
    
    function startFallingElements() {
        if (fallingElementsInterval) clearInterval(fallingElementsInterval);
        const container = document.getElementById('falling-elements-container');
        if(!container) return;
        container.innerHTML = '';
        const elements = ['🌺', '🌹', '🌸', '🌷', '🌼', '🏵️', '💮'];
        fallingElementsInterval = setInterval(() => {
            const element = document.createElement('div');
            element.className = 'falling-element';
            element.textContent = elements[Math.floor(Math.random() * elements.length)];
            element.style.left = Math.random() * 100 + 'vw';
            element.style.animationDuration = Math.random() * 5 + 5 + 's';
            element.style.fontSize = Math.random() * 1.5 + 1 + 'rem';
            container.appendChild(element);
            setTimeout(() => { element.remove(); }, 10000);
        }, 300);
    }

    function speakMessage(text) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'hi-IN';
        utterance.rate = 0.9;
        utterance.pitch = 1.1;
        window.speechSynthesis.speak(utterance);
    }

    function setupMainInterfacePage(userName) {
        const messageText = `प्रिय ${userName},\n\nरक्षा बंधन की हार्दिक शुभकामनाएँ!\nयह पावन पर्व हमारे रिश्ते की डोर को और भी मज़बूत करता है। ईश्वर से यही प्रार्थना है कि हमारे रिश्ते की मिठास कभी कम न हो।`;
        document.getElementById('main-interface-message').textContent = messageText;
        showPage('main-interface-page');
        setTimeout(() => speakMessage(messageText), 1500);
    }
    
    function getFormattedMessageText() {
        const sender = document.getElementById('sender-name').value;
        const receiver = document.getElementById('receiver-name').value;
        let messageTemplate = messages[messageType][currentMessageIndex];
        let formattedMessage = messageTemplate.replace(/मेरी प्यारी बहना/g, `मेरी प्यारी बहना ${receiver}`)
                                            .replace(/प्यारी बहन/g, `प्यारी बहन ${receiver}`)
                                            .replace(/बहना/g, `बहना ${receiver}`)
                                            .replace(/मेरे प्यारे भाई/g, `मेरे प्यारे भाई ${receiver}`)
                                            .replace(/भैया/g, `भैया ${receiver}`)
                                            .replace(/भाई/g, `भाई ${receiver}`);
        return formattedMessage + `\n\nतुम्हारा/तुम्हारी,\n${sender}`;
    }

    function displayCurrentMessage() {
        document.getElementById('message-display-card').textContent = getFormattedMessageText();
    }

    window.addEventListener('load', async () => {
        const wasMessageHandled = await handleSharedMessage();
        if (!wasMessageHandled) {
            // Only show landing page if no shared message was displayed
            showPage('landing-page');
        }
    });

    speakerIcon.addEventListener('click', toggleMusic);

    document.getElementById('get-started-btn').addEventListener('click', () => {
        audio.play().then(() => audio.pause()).catch(() => {});
        if (localStorage.getItem('rakshaSutraUserId')) {
            setupMainInterfacePage(localStorage.getItem('rakshaSutraUserName'));
        } else {
            showPage('form-page');
        }
    });

    document.getElementById('info-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        const phone = document.getElementById('phone').value;
        const name = document.getElementById('name').value;
        const address = document.getElementById('address').value;
        try {
            await setDoc(doc(db, "users", phone), { name, phone, address, timestamp: serverTimestamp() });
            localStorage.setItem('rakshaSutraUserName', name);
            localStorage.setItem('rakshaSutraUserId', phone);
            alert(`धन्यवाद, ${name}! आपकी प्रोफ़ाइल बन गई है।`);
            setupMainInterfacePage(name);
        } catch (error) {
            alert("एक त्रुटि हुई: " + error.message);
        } finally {
            submitButton.disabled = false;
        }
    });
    
    document.getElementById('update-profile-btn').addEventListener('click', async () => {
        const userId = localStorage.getItem('rakshaSutraUserId');
        if (!userId) return;
        const newName = document.getElementById('profile-name-input').value;
        const newAddress = document.getElementById('profile-address-input').value;
        if (!newName || !newAddress) return alert("नाम और पता खाली नहीं हो सकता।");
        const userDocRef = doc(db, "users", userId);
        try {
            await updateDoc(userDocRef, { name: newName, address: newAddress });
            localStorage.setItem('rakshaSutraUserName', newName);
            alert("प्रोफ़ाइल सफलतापूर्वक अपडेट की गई!");
        } catch (error) {
            alert("अपडेट करते समय एक त्रुटि हुई: " + error.message);
        }
    });

    document.getElementById('mystery-box-btn').addEventListener('click', () => showPage('home-page'));
    document.getElementById('open-message-creator-btn').addEventListener('click', () => showPage('message-creator-page'));
    document.getElementById('open-card-creator-btn').addEventListener('click', () => showPage('card-message-input-page'));
    document.getElementById('change-music-strip').addEventListener('click', () => showPage('music-page'));
    document.getElementById('my-profile-strip').addEventListener('click', () => showPage('profile-page'));
    
    document.getElementById('whatsapp-share-strip').addEventListener('click', () => {
        const message = encodeURIComponent(`इस रक्षाबंधन, अपने भाई-बहन को एक विशेष डिजिटल राखी भेजें! इस खूबसूरत वेबसाइट को देखें: ${window.location.href.split('?')[0]}`);
        window.open(`https://api.whatsapp.com/send?text=${message}`, '_blank');
    });

    document.querySelectorAll('.back-link').forEach(link => {
        link.addEventListener('click', (e) => { e.preventDefault(); showPage(link.dataset.target); });
    });
    
    document.querySelectorAll('.music-btn').forEach(button => {
        button.addEventListener('click', () => {
            audio.src = button.dataset.src;
            toggleMusic(); 
            showPage('home-page');
        });
    });
    
    document.getElementById('bhai-to-bhen-btn').addEventListener('click', () => { messageType = 'bhai-to-bhen'; showPage('message-name-form-page'); });
    document.getElementById('bhen-to-bhai-btn').addEventListener('click', () => { messageType = 'bhen-to-bhai'; showPage('message-name-form-page'); });
    
    document.getElementById('message-name-form').addEventListener('submit', (e) => {
        e.preventDefault();
        currentMessageIndex = 0;
        displayCurrentMessage();
        showPage('message-display-page');
    });
    
    document.getElementById('whatsapp-share-message-btn').addEventListener('click', async () => {
        const fullMessageText = getFormattedMessageText();
        const newShareId = generateShareId();
        try {
            await addDoc(collection(db, "sharedMessages"), {
                shareId: newShareId,
                fullMessage: fullMessageText,
                createdAt: serverTimestamp()
            });
            const receiverName = document.getElementById('receiver-name').value;
            const baseUrl = window.location.href.split('?')[0]; 
            const shareUrl = `${baseUrl}?shareId=${newShareId}`;
            const message = encodeURIComponent(`नमस्ते ${receiverName}, आपके लिए एक विशेष रक्षाबंधन संदेश है! इसे देखने के लिए लिंक पर क्लिक करें:\n${shareUrl}`);
            window.open(`https://api.whatsapp.com/send?text=${message}`, '_blank');
        } catch (error) {
            console.error("Error saving/sharing message: ", error);
            alert("संदेश शेयर करने में त्रुटि हुई।");
        }
    });

    let messageTouchStartX = 0;
    const messageCard = document.getElementById('message-display-page');
    messageCard.addEventListener('touchstart', e => { messageTouchStartX = e.changedTouches[0].screenX; }, { passive: true });
    messageCard.addEventListener('touchend', e => {
        const touchendX = e.changedTouches[0].screenX;
        const totalMessages = messages[messageType].length;
        if (touchendX < messageTouchStartX - 50) {
            currentMessageIndex = (currentMessageIndex + 1) % totalMessages;
            displayCurrentMessage();
        }
        if (touchendX > messageTouchStartX + 50) {
            currentMessageIndex = (currentMessageIndex - 1 + totalMessages) % totalMessages;
            displayCurrentMessage();
        }
    });

</script>
</body>
</html>
