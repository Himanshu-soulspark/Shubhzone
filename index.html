<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shubhzone</title>

    <style>
        :root {
            --dark-bg: #0f0f0f;
            --primary-text: #ffffff;
            --secondary-text: #aaaaaa;
            --card-bg: #212121;
            --accent-gradient: linear-gradient(90deg, #ff416c, #ff4b2b);
            --modal-bg: rgba(0, 0, 0, 0.85);
            --placeholder-bg: #2a2a2a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: var(--dark-bg); color: var(--primary-text); overflow-x: hidden; }
        .page { padding: 20px 15px 80px 15px; display: none; min-height: calc(100vh - 65px); overflow-y: auto; }
        .page.active { display: block; }
        h2 { color: var(--primary-text); margin-bottom: 20px; }
        .button { width: 100%; padding: 15px; border: none; border-radius: 10px; background: var(--accent-gradient); color: white; font-size: 18px; font-weight: bold; cursor: pointer; text-align: center; }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* HOMEPAGE: PLAYLIST LAYOUT */
        .playlist-section { margin-bottom: 30px; }
        .playlist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .playlist-header h3 { font-size: 20px; }
        .video-grid-3xN { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .video-card-grid { background-color: transparent; border-radius: 10px; overflow: hidden; cursor: pointer; }
        .video-card-grid .thumbnail { width: 100%; aspect-ratio: 9 / 16; background-color: var(--placeholder-bg); background-size: cover; background-position: center; border-radius: 8px; margin-bottom: 5px; }
        .video-card-grid .info p { font-size: 12px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--secondary-text); }

        /* UPLOAD PAGE */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: var(--secondary-text); margin-bottom: 8px; font-size: 14px; }
        .form-group input[type="text"], .form-group select, .form-group textarea { width: 100%; background-color: var(--card-bg); border: 1px solid #444; border-radius: 8px; padding: 12px; color: var(--primary-text); font-size: 16px; -webkit-appearance: none; appearance: none; }
        .form-group textarea { resize: vertical; }
        .radio-group label { margin-right: 15px; }
        .radio-group input[type="radio"] { margin-right: 5px; }
        .playlist-selection { display: flex; gap: 10px; }
        .playlist-selection select { flex-grow: 1; }
        .playlist-selection .add-new-btn { padding: 12px; font-size: 24px; line-height: 1; border-radius: 8px; background-color: var(--card-bg); border: 1px solid #444; }
        .file-upload-container { display: flex; gap: 15px; margin-bottom: 20px; }
        .file-uploader-card { flex: 1; border: 2px dashed #444; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--placeholder-bg); aspect-ratio: 9 / 16; cursor: pointer; overflow: hidden; position: relative; }
        .file-uploader-card .upload-text { text-align: center; color: var(--secondary-text); padding: 10px; }
        .file-uploader-card .preview-video, .file-uploader-card .preview-image { position: absolute; width: 100%; height: 100%; object-fit: cover; display: none; }

        /* PROFILE PAGE */
        .file-upload-button { background-color: var(--card-bg); border: 1px solid #444; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; color: var(--secondary-text); }

        /* MODAL FOR NEW PLAYLIST */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); z-index: 250; display: none; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background-color: var(--card-bg); padding: 25px; border-radius: 15px; width: 100%; max-width: 400px; position: relative; }
        .modal .close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; color: var(--secondary-text); cursor: pointer; }
        #newPlaylistThumbUploader { width: 100%; aspect-ratio: 9 / 16; border: 2px dashed #444; border-radius: 10px; display: flex; justify-content: center; align-items: center; background-color: var(--placeholder-bg); cursor: pointer; position: relative; overflow: hidden; }
        #newPlaylistThumbUploader .preview-image { position: absolute; width: 100%; height: 100%; object-fit: cover; display: none; }

        /* BOTTOM NAVIGATION */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(15,15,15,0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid rgba(255, 255, 255, 0.1); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text); cursor: pointer; flex: 1; text-align: center; }
        .nav-item.active { color: var(--primary-text); }
        .nav-item.upload-plus { position: relative; top: -15px; }
        .nav-icon { width: 28px; height: 28px; }
        .nav-icon.upload-icon { width: 50px; height: 50px; background: var(--accent-gradient); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 10px rgba(255, 75, 43, 0.5); }
        .nav-label { font-size: 10px; margin-top: 2px; }

        /* VIDEO PLAYER (Unchanged) */
        #videoPlayerOverlay { /* ... same styles as before ... */ }
    </style>
</head>
<body>

    <!-- ======== HOMEPAGE ======== -->
    <div id="homePage" class="page active">
        <div id="playlist-container"></div>
        <p id="home-status-message" style="text-align: center; color: var(--secondary-text); padding: 50px 0; display: none;"></p>
    </div>

    <!-- ======== UPLOAD PAGE ======== -->
    <div id="uploadPage" class="page">
        <h2>Upload Video</h2>
        <div class="form-group"><label for="videoTitle">Video Title</label><input type="text" id="videoTitle" placeholder="Enter a catchy title"></div>
        <div class="form-group">
            <label for="playlistSelect">Add to Playlist</label>
            <div class="playlist-selection">
                <select id="playlistSelect"></select>
                <button class="add-new-btn" onclick="openPlaylistModal()">+</button>
            </div>
        </div>
        <div class="form-group">
            <label>Audience</label>
            <div class="radio-group">
                <input type="radio" id="ageAll" name="age_restriction" value="all" checked> <label for="ageAll">For Everyone</label>
                <input type="radio" id="age18" name="age_restriction" value="18+"> <label for="age18">18+ Only</label>
            </div>
        </div>
        <div class="file-upload-container">
            <div class="file-uploader-card" onclick="document.getElementById('videoFileInput').click()">
                 <span class="upload-text">Select Video</span>
                 <video class="preview-video" muted></video>
            </div>
            <div class="file-uploader-card" onclick="document.getElementById('thumbnailInput').click()">
                 <span class="upload-text">Select Thumbnail</span>
                 <img class="preview-image" alt="Video Thumbnail"/>
            </div>
        </div>
        <input type="file" id="videoFileInput" style="display: none;" accept="video/*">
        <input type="file" id="thumbnailInput" style="display: none;" accept="image/*">
        <button id="uploadButton" class="button" onclick="uploadVideo()">âœ… Upload Video</button>
    </div>
    
    <!-- ======== PROFILE PAGE ======== -->
    <div id="infoSubmissionPage" class="page">
        <h2>Submit Your Information</h2>
        <p style="color: var(--secondary-text); margin-bottom: 25px;">This information is required for verification.</p>
        <div class="form-group"><label for="fullName">Full Name</label><input type="text" id="fullName" placeholder="Your full name as on ID"></div>
        <div class="form-group"><label for="email">Email Address</label><input type="email" id="email" placeholder="Your primary email"></div>
        <div class="form-group"><label for="address">Full Address</label><textarea id="address" placeholder="Your full residential address"></textarea></div>
        <div class="form-group">
            <label>Your Photos (2 required)</label>
            <div class="file-upload-button" onclick="document.getElementById('photo1').click()">Select Photo 1</div>
            <div class="file-upload-button" onclick="document.getElementById('photo2').click()" style="margin-top:10px;">Select Photo 2</div>
            <input type="file" id="photo1" style="display:none;" accept="image/*"><input type="file" id="photo2" style="display:none;" accept="image/*">
        </div>
         <div class="form-group">
            <label>Government ID Proof (Aadhaar, etc.)</label>
            <div class="file-upload-button" onclick="document.getElementById('govId').click()">Select ID Proof</div>
            <input type="file" id="govId" style="display:none;" accept="image/*,application/pdf">
        </div>
        <button class="button" onclick="submitForApproval()">Submit for Approval</button>
    </div>

    <!-- ======== USER DASHBOARD (After Approval) ======== -->
    <div id="userDashboardPage" class="page">
        <h2>My Profile</h2>
        <p>Your profile is active.</p>
    </div>

    <!-- ======== BOTTOM NAVIGATION BAR ======== -->
    <nav class="bottom-nav">
        <div id="navHome" class="nav-item active" onclick="showPage('homePage')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" /></svg>
            <span class="nav-label">Home</span>
        </div>
        <div class="nav-item upload-plus" onclick="showPage('uploadPage')">
            <div class="nav-icon upload-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg></div>
        </div>
        <div id="navProfile" class="nav-item" onclick="handleProfileClick()">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" /></svg>
            <span class="nav-label">Profile</span>
        </div>
    </nav>

    <!-- ======== NEW PLAYLIST MODAL ======== -->
    <div id="newPlaylistModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePlaylistModal()">Ã—</span>
            <h3>Create New Playlist</h3>
            <div class="form-group"><label for="newPlaylistName">Playlist Name</label><input type="text" id="newPlaylistName" placeholder="e.g., Devotional Songs"></div>
            <div class="form-group">
                <label>Playlist Thumbnail (9:16)</label>
                <div id="newPlaylistThumbUploader" onclick="document.getElementById('newPlaylistThumb').click()">
                     <span class="upload-text">Select Thumbnail</span>
                     <img class="preview-image" id="newPlaylistPreview" alt="Playlist Thumbnail Preview"/>
                </div>
                <input type="file" id="newPlaylistThumb" style="display:none" accept="image/*" onchange="previewFile(this, 'newPlaylistPreview')">
            </div>
            <button id="createPlaylistBtn" class="button" onclick="handleCreatePlaylist()">Create Playlist</button>
        </div>
    </div>

    <!-- ======== VIDEO PLAYER OVERLAY ======== -->
    <div id="videoPlayerOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 300;">
        <!-- The professional video player logic will control this element -->
        <video id="mainPlayer" style="width: 100%; height: 100%;" controls playsinline></video>
        <button onclick="closePlayer()" style="position: absolute; top: 15px; left: 15px; color: white; background: rgba(0,0,0,0.5); border: none; font-size: 24px; border-radius: 50%; width: 40px; height: 40px;"><</button>
    </div>

    <script>
        // ======== SCRIPT SECTION (COMPLETE) ========
        let isUserApproved = false;
        const API_BASE_URL = window.location.origin;

        function setButtonLoading(button, isLoading, originalText = '') {
            if (isLoading) {
                button.disabled = true;
                button.textContent = 'Loading...';
            } else {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        async function handleApiResponse(response) {
            if (!response.ok) {
                let errorMsg = `Error: ${response.status} ${response.statusText}`;
                try {
                    const errorJson = await response.json();
                    errorMsg = errorJson.message || errorMsg;
                } catch (e) { /* Ignore if response is not JSON */ }
                throw new Error(errorMsg);
            }
            return response.json();
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (pageId === 'homePage') document.getElementById('navHome').classList.add('active');
            if (pageId.includes('Submission') || pageId.includes('Dashboard')) document.getElementById('navProfile').classList.add('active');
        }

        async function populateHomePage() {
            const container = document.getElementById('playlist-container');
            const statusMsg = document.getElementById('home-status-message');
            container.innerHTML = '';
            statusMsg.textContent = 'Loading...';
            statusMsg.style.display = 'block';

            try {
                const data = await fetch(`${API_BASE_URL}/api/home-content`).then(handleApiResponse);
                if (!data.success) throw new Error(data.message);
                
                if (data.playlists.length === 0) {
                    statusMsg.textContent = 'No playlists found. Create one to get started!';
                    return;
                }
                statusMsg.style.display = 'none';

                data.playlists.forEach(playlist => {
                    const playlistVideos = data.videos.filter(v => v.playlist_id === playlist.id);
                    if (playlistVideos.length === 0) return;

                    const section = document.createElement('div');
                    section.className = 'playlist-section';
                    section.innerHTML = `
                        <div class="playlist-header"><h3>${playlist.name}</h3></div>
                        <div class="video-grid-3xN">
                            ${playlistVideos.map(video => `
                                <div class="video-card-grid" onclick="playVideo('${video.video_key}', '${video.title}')">
                                    <div class="thumbnail" style="background-image: url('${video.thumbnailUrl}')"></div>
                                    <div class="info"><p>${video.title}</p></div>
                                </div>`).join('')}
                        </div>`;
                    container.appendChild(section);
                });
            } catch (error) {
                console.error('Error populating home page:', error);
                statusMsg.textContent = error.message;
                statusMsg.style.color = '#F44336';
            }
        }

        const playlistSelect = document.getElementById('playlistSelect');
        const newPlaylistModal = document.getElementById('newPlaylistModal');

        async function populatePlaylistDropdown() {
            try {
                const playlists = await fetch(`${API_BASE_URL}/api/playlists`).then(handleApiResponse);
                playlistSelect.innerHTML = '';
                if (playlists.length === 0) {
                    playlistSelect.innerHTML = '<option disabled selected>Create a playlist first</option>';
                    return;
                }
                playlists.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    playlistSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching playlists:', error);
            }
        }

        function openPlaylistModal() { newPlaylistModal.style.display = 'flex'; }
        function closePlaylistModal() { newPlaylistModal.style.display = 'none'; }
        
        function previewFile(input, previewId) {
            const file = input.files[0];
            const preview = document.getElementById(previewId);
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            }
        }

        async function handleCreatePlaylist() {
            const nameInput = document.getElementById('newPlaylistName');
            const thumbInput = document.getElementById('newPlaylistThumb');
            const createBtn = document.getElementById('createPlaylistBtn');
            if (!nameInput.value || thumbInput.files.length === 0) {
                alert('Please provide a playlist name and a thumbnail.');
                return;
            }
            setButtonLoading(createBtn, true);
            try {
                const thumbFile = thumbInput.files[0];
                const urlResponse = await fetch(`${API_BASE_URL}/api/generate-upload-url?fileName=${encodeURIComponent(thumbFile.name)}&contentType=${thumbFile.type}`).then(handleApiResponse);
                await fetch(urlResponse.uploadUrl, { method: 'PUT', body: thumbFile });
                const playlistData = { name: nameInput.value, thumbnail_key: urlResponse.key };
                const saveResponse = await fetch(`${API_BASE_URL}/api/playlists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(playlistData)
                }).then(handleApiResponse);
                alert(`Playlist "${saveResponse.playlist.name}" created!`);
                closePlaylistModal();
                populatePlaylistDropdown();
                nameInput.value = '';
                thumbInput.value = '';
                document.getElementById('newPlaylistPreview').style.display = 'none';
            } catch (error) {
                alert(`Failed to create playlist: ${error.message}`);
            } finally {
                setButtonLoading(createBtn, false, 'Create Playlist');
            }
        }

        async function uploadVideo() {
            const videoInput = document.getElementById('videoFileInput');
            const thumbInput = document.getElementById('thumbnailInput');
            const title = document.getElementById('videoTitle').value;
            const selectedPlaylistId = playlistSelect.value;
            const ageRestriction = document.querySelector('input[name="age_restriction"]:checked').value;
            const uploadBtn = document.getElementById('uploadButton');
            
            if (!videoInput.files[0] || !thumbInput.files[0] || !title || !selectedPlaylistId) {
                alert('Please fill all fields: Title, Playlist, Video, and Thumbnail.');
                return;
            }
            setButtonLoading(uploadBtn, true);
            try {
                const videoFile = videoInput.files[0];
                const videoUrlRes = await fetch(`${API_BASE_URL}/api/generate-upload-url?fileName=${encodeURIComponent(videoFile.name)}&contentType=${videoFile.type}`).then(handleApiResponse);
                await fetch(videoUrlRes.uploadUrl, { method: 'PUT', body: videoFile });

                const thumbFile = thumbInput.files[0];
                const thumbUrlRes = await fetch(`${API_BASE_URL}/api/generate-upload-url?fileName=${encodeURIComponent(thumbFile.name)}&contentType=${thumbFile.type}`).then(handleApiResponse);
                await fetch(thumbUrlRes.uploadUrl, { method: 'PUT', body: thumbFile });

                const videoDetails = { title, video_key: videoUrlRes.key, thumbnail_key: thumbUrlRes.key, playlist_id: selectedPlaylistId, age_restriction: ageRestriction };
                await fetch(`${API_BASE_URL}/api/videos`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(videoDetails) }).then(handleApiResponse);
                
                alert('Video uploaded successfully!');
                showPage('homePage');
                populateHomePage();
            } catch (error) {
                alert(`Upload failed: ${error.message}`);
            } finally {
                setButtonLoading(uploadBtn, false, 'âœ… Upload Video');
            }
        }

        function handleProfileClick() {
            showPage(isUserApproved ? 'userDashboardPage' : 'infoSubmissionPage');
        }

        function submitForApproval() {
            alert('Information submitted for verification.');
        }

        const playerOverlay = document.getElementById('videoPlayerOverlay');
        const mainPlayer = document.getElementById('mainPlayer');
        async function playVideo(videoKey, title) {
            playerOverlay.style.display = 'block';
            mainPlayer.src = ''; // Clear previous source
            try {
                const data = await fetch(`${API_BASE_URL}/api/videos/${videoKey}/play`).then(handleApiResponse);
                if (data.success) {
                    mainPlayer.src = data.url;
                    mainPlayer.play();
                } else {
                    throw new Error('Could not get video URL.');
                }
            } catch(error) {
                alert(`Error playing video: ${error.message}`);
                closePlayer();
            }
        }

        function closePlayer() {
            mainPlayer.pause();
            mainPlayer.src = '';
            playerOverlay.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            showPage('homePage');
            populateHomePage();
            populatePlaylistDropdown();
        });
    </script>
</body>
</html>
