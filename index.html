<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shubhzone</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>

    <style>
        :root {
            --dark-bg: #121212;
            --primary-text: #ffffff;
            --secondary-text: #b3b3b3;
            --card-bg: #1e1e1e;
            --accent-gradient: linear-gradient(90deg, #ff416c, #ff4b2b);
            --transparent-black: rgba(0, 0, 0, 0.7);
            --placeholder-bg: #2a2a2a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--dark-bg);
            color: var(--primary-text);
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .page {
            padding: 20px 15px 80px 15px;
            display: none;
            min-height: calc(100vh - 65px);
        }
        .page.active { display: block; }
        h2 { color: var(--primary-text); margin-bottom: 15px; }
        .button, .submit-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: var(--accent-gradient);
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
        }
        .button:disabled { background: var(--secondary-text); cursor: not-allowed; }
        .slider-container { width: 100%; overflow: hidden; border-radius: 12px; }
        .slider-wrapper { display: flex; transition: transform 0.8s ease; }
        .slider-card { flex: 0 0 100%; aspect-ratio: 16 / 9; background-size: cover; background-position: center; }
        .search-bar { display: flex; align-items: center; background-color: var(--card-bg); border-radius: 25px; padding: 8px 15px; margin: 20px 0; }
        .search-bar input { flex-grow: 1; background: none; border: none; outline: none; color: var(--primary-text); font-size: 16px; margin: 0 10px; }
        .search-bar .icon { width: 24px; height: 24px; color: var(--secondary-text); cursor: pointer; }
        .video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .video-card { background-color: var(--card-bg); border-radius: 10px; overflow: hidden; cursor: pointer; }
        .video-thumbnail-container { width: 100%; aspect-ratio: 16 / 9; background-color: var(--placeholder-bg); display: flex; justify-content: center; align-items: center; }
        .video-thumbnail-container img { width: 100%; height: 100%; object-fit: cover; }
        .video-thumbnail-container svg { width: 30%; height: 30%; max-width: 48px; fill: var(--secondary-text); }
        .video-card-info { padding: 8px; }
        .video-card-info p { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--transparent-black);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text); cursor: pointer; }
        .nav-item.active { color: var(--primary-text); }
        .nav-item.active .nav-icon { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-item.upload-plus { position: relative; top: -15px; }
        .nav-icon { width: 28px; height: 28px; }
        .nav-icon.upload-icon { width: 50px; height: 50px; background: var(--accent-gradient); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .nav-label { font-size: 10px; margin-top: 2px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: var(--secondary-text); margin-bottom: 8px; font-size: 14px; }
        .form-group input[type="text"], .form-group textarea { width: 100%; background-color: var(--card-bg); border: 1px solid #444; border-radius: 8px; padding: 12px; color: var(--primary-text); font-size: 16px; }
        .progress-bar-container { width: 100%; background-color: var(--card-bg); border-radius: 5px; overflow: hidden; margin-top: 10px; display: none; }
        #progressBar { width: 0%; height: 10px; background: var(--accent-gradient); }
        #progressText { text-align: center; font-size: 12px; color: var(--secondary-text); margin-top: 5px; }
        .thumbnail-uploader { border: 2px dashed #444; border-radius: 10px; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px; color: var(--secondary-text); cursor: pointer; background-color: var(--placeholder-bg); }
        .thumbnail-uploader.landscape { aspect-ratio: 16 / 9; }
    </style>
</head>
<body>

    <div id="homePage" class="page active">
        <div class="slider-container">
            <div class="slider-wrapper"></div>
        </div>
        <div class="search-bar">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            <input type="text" placeholder="Search videos...">
            <svg onclick="showPage('historyPage')" class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        </div>
        <div class="video-grid" id="homeVideoGrid"></div>
    </div>

    <div id="shortsPage" class="page">
        <p>Shorts Feature Coming Soon!</p>
    </div>

    <div id="uploadPage" class="page">
        <h2>Upload Video</h2>
        <div class="form-group"><label for="videoTitle">Video Title</label><input type="text" id="videoTitle" placeholder="Enter a catchy title"></div>
        <div class="form-group"><label for="description">Description</label><textarea id="description" placeholder="Tell viewers about your video"></textarea></div>
        <div class="form-group"><label for="tags">Tags</label><input type="text" id="tags" placeholder="e.g., tech, comedy, music"></div>
        <div class="form-group">
            <label>Video File</label>
            <div class="thumbnail-uploader landscape" id="videoUploader" onclick="document.getElementById('videoFileInput').click()">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16"><path d="M4.502 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/><path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2zM14 2H4a1 1 0 0 0-1 1v9l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V3a1 1 0 0 0-1-1z"/></svg>
                <p>Tap to select a video file</p>
            </div>
            <input type="file" id="videoFileInput" style="display: none;" accept="video/*" onchange="updateFileLabel('videoFileInput', 'videoUploader')">
        </div>
        <div class="form-group">
            <label>Thumbnail Image (16:9)</label>
            <div class="thumbnail-uploader landscape" id="thumbnailUploader" onclick="document.getElementById('thumbnailInput').click()">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16"><path d="M4.502 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/><path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2zM14 2H4a1 1 0 0 0-1 1v9l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V3a1 1 0 0 0-1-1z"/></svg>
                <p>Tap to select a thumbnail</p>
            </div>
            <input type="file" id="thumbnailInput" style="display: none;" accept="image/*" onchange="updateFileLabel('thumbnailInput', 'thumbnailUploader')">
        </div>
        <div id="uploadSubmitButton" class="button upload-button" onclick="uploadVideo()">âœ… Upload Video</div>
        <div class="progress-bar-container" id="progressContainer">
            <div id="progressBar"></div>
            <p id="progressText">0%</p>
        </div>
    </div>
    
    <div id="chatPage" class="page">
        <!-- Chat page content -->
    </div>
    <div id="infoSubmissionPage" class="page">
        <!-- Info submission page content -->
    </div>
    <div id="userDashboardPage" class="page">
        <!-- User dashboard content -->
    </div>

    <nav class="bottom-nav">
        <div id="navHome" class="nav-item active" onclick="showPage('homePage')"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4.75 9.5a.75.75 0 0 0 0 1.5h.5a.75.75 0 0 0 0-1.5h-.5ZM6 11a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 6 11Zm-1.25 2a.75.75 0 0 0 0 1.5h.5a.75.75 0 0 0 0-1.5h-.5ZM6 15a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 6 15Zm11-5.5a.75.75 0 0 0 0 1.5h.5a.75.75 0 0 0 0-1.5h-.5Zm1.25 1.25a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1-.75-.75Zm-1.25 2a.75.75 0 0 0 0 1.5h.5a.75.75 0 0 0 0-1.5h-.5Zm1.25 1.25a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h.5a.75.75 0 0 1-.75-.75ZM21 8.5v8a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-8a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3ZM8.5 8a.5.5 0 0 0-1 0v8a.5.5 0 0 0 1 0v-8Zm3 0a.5.5 0 0 0-1 0v8a.5.5 0 0 0 1 0v-8Zm3 0a.5.5 0 0 0-1 0v8a.5.5 0 0 0 1 0v-8Z"/></svg><span class="nav-label">Long Video</span></div>
        <div id="navShorts" class="nav-item" onclick="showPage('shortsPage')" style="display: none;"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.968 2.055a.75.75 0 0 0-1.06-.092l-6.5 5.5a.75.75 0 0 0 .592 1.287h2.75v5.5h-2.75a.75.75 0 0 0-.592 1.287l6.5 5.5a.75.75 0 0 0 1.06-.092l6.5-5.5a.75.75 0 0 0-.592-1.287h-2.75v-5.5h2.75a.75.75 0 0 0 .592-1.287l-6.5-5.5Z"/></svg><span class="nav-label">Shorts</span></div>
        <div class="nav-item upload-plus" onclick="showPage('uploadPage')"><div class="nav-icon upload-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></div></div>
        <div id="navChat" class="nav-item" onclick="showPage('chatPage')"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0 1 12 2.25c2.43 0 4.817.178 7.152.52 1.978.292 3.348 2.024 3.348 3.97v6.02c0 1.946-1.37 3.678-3.348 3.97a48.901 48.901 0 0 1-14.304 0c-1.978-.292-3.348-2.024-3.348-3.97V6.741c0-1.946 1.37-3.678 3.348-3.97ZM6.75 8.25a.75.75 0 0 1 .75-.75h9a.75.75 0 0 1 0 1.5h-9a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5H12a.75.75 0 0 0 0-1.5H7.5Z" clip-rule="evenodd" /></svg><span class="nav-label">Chat</span></div>
        <div id="navProfile" class="nav-item" onclick="handleProfileClick()"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653ZM5.855 16.52a7.486 7.486 0 0 1 5.855-2.812c1.585 0 3.065.392 4.392 1.07a6.241 6.241 0 0 0-10.247 0ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" /></svg><span class="nav-label">Profile</span></div>
    </nav>
    
    <script>
        const firebaseConfig = {
            authDomain: "shubhzone-4a6b0.firebaseapp.com",
            databaseURL: "https://shubhzone-4a6b0-default-rtdb.firebaseio.com",
            projectId: "shubhzone-4a6b0",
            storageBucket: "shubhzone-4a6b0.firebasestorage.app",
            messagingSenderId: "439309269785",
            appId: "1:439309269785:web:08a1256812648daafea388",
            measurementId: "G-5S0VFF21SB"
        };
        if (typeof firebase !== 'undefined') {
            try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase init failed:", e); }
        }

        let isUserApproved = false;
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');

        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            navItems.forEach(item => item.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            let activeNavItemId = 'nav' + pageId.charAt(0).toUpperCase() + pageId.slice(1).replace('Page', '');
            const activeNavItem = document.getElementById(activeNavItemId);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            } else if (pageId === 'uploadPage') {
                document.querySelector('.upload-plus').classList.add('active');
            }
        }

        function populateHomeContent() {
            const sliderWrapper = document.querySelector('#homePage .slider-wrapper');
            if(sliderWrapper){
                sliderWrapper.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    sliderWrapper.innerHTML += `<div class="slider-card" style="background-image: url('https://picsum.photos/seed/slider${i}/800/450')"></div>`;
                }
            }
            fetchAndDisplayVideos();
        }

        async function fetchAndDisplayVideos() {
            const videoGrid = document.getElementById('homeVideoGrid');
            if (!videoGrid) return;
            videoGrid.innerHTML = '<p style="color: var(--secondary-text); grid-column: 1 / -1;">Loading videos...</p>';
            const bunnyPullZoneUrl = 'https://shubhzone-cdn.b-cdn.net';
            
            try {
                const response = await fetch('/api/videos');
                const videos = await response.json();
                
                videoGrid.innerHTML = ''; 
                if (videos.length === 0) {
                    videoGrid.innerHTML = '<p style="color: var(--secondary-text); grid-column: 1 / -1;">No videos have been uploaded yet.</p>';
                } else {
                    videos.forEach(video => {
                        const thumbnailContent = video.thumbnail_key
                            ? `<img src="${bunnyPullZoneUrl}/${video.thumbnail_key}" alt="${video.title}" onerror="this.style.display='none'; this.parentElement.querySelector('svg').style.display='block';">
                               <svg style="display:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.647c1.295.746 1.295 2.54 0 3.286L7.279 20.99c-1.25.717-2.779-.217-2.779-1.643V5.653Z" /></svg>`
                            : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.647c1.295.746 1.295 2.54 0 3.286L7.279 20.99c-1.25.717-2.779-.217-2.779-1.643V5.653Z" /></svg>`;

                        const videoCardHTML = `
                            <div class="video-card" onclick="playVideo('${video.video_key}')">
                                <div class="video-thumbnail-container">
                                    ${thumbnailContent}
                                </div>
                                <div class="video-card-info"><p>${video.title}</p></div>
                            </div>`;
                        videoGrid.innerHTML += videoCardHTML;
                    });
                }
            } catch (error) {
                videoGrid.innerHTML = '<p style="color: var(--reject-red); grid-column: 1 / -1;">Error: Could not load videos.</p>';
            }
        }
        
        async function playVideo(videoKey) {
            try {
                const response = await fetch(`/api/videos/${videoKey}/play`);
                const data = await response.json();
                if (data.success) {
                    window.open(data.url, '_blank');
                } else {
                    alert('Error: Could not get video link.');
                }
            } catch (error) {
                alert('An error occurred while trying to play the video.');
            }
        }

        function updateFileLabel(inputId, uploaderId) {
            const fileInput = document.getElementById(inputId);
            const uploaderP = document.querySelector(`#${uploaderId} p`);
            if (fileInput.files.length > 0) {
                uploaderP.textContent = fileInput.files[0].name;
            }
        }
        
        async function uploadVideo() {
            const uploadButton = document.getElementById('uploadSubmitButton');
            const videoInput = document.getElementById('videoFileInput');
            const thumbnailInput = document.getElementById('thumbnailInput');
            const progressContainer = document.getElementById('progressContainer');
            
            const videoFile = videoInput.files[0];
            const thumbnailFile = thumbnailInput.files[0];
            const title = document.getElementById('videoTitle').value;

            if (!videoFile || !title) {
                alert('Please select a video file and enter a title.');
                return;
            }

            uploadButton.disabled = true;
            progressContainer.style.display = 'block';

            try {
                const videoKey = await uploadFileWithProgress(videoFile, 'video');
                let thumbnailKey = null;
                if (thumbnailFile) {
                    thumbnailKey = await uploadFileWithProgress(thumbnailFile, 'thumbnail');
                }
                
                const progressText = document.getElementById('progressText');
                progressText.textContent = 'Saving details...';

                const saveResponse = await fetch('/api/save-video-details', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: document.getElementById('description').value,
                        tags: document.getElementById('tags').value,
                        video_key: videoKey,
                        thumbnail_key: thumbnailKey
                    })
                });
                if (!saveResponse.ok) { throw new Error('Failed to save video details.'); }
                
                alert('Upload successful!');
                showPage('homePage');
                populateHomeContent();
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            } finally {
                uploadButton.disabled = false;
                progressContainer.style.display = 'none';
                document.getElementById('uploadPage').querySelector('form')? document.getElementById('uploadPage').querySelector('form').reset() : null;
            }
        }
        
        function uploadFileWithProgress(file, type) {
            return new Promise(async (resolve, reject) => {
                const progressText = document.getElementById('progressText');
                const progressBar = document.getElementById('progressBar');
                try {
                    progressText.textContent = `Getting ${type} upload link...`;
                    progressBar.style.width = '0%';
                    const urlResponse = await fetch(`/api/generate-upload-url?fileName=${encodeURIComponent(file.name)}`);
                    const urlData = await urlResponse.json();
                    if (!urlData.success) { return reject(new Error(`Could not get ${type} upload URL.`)); }
                    
                    const { uploadUrl, key } = urlData;
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', uploadUrl, true);
                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const percentComplete = Math.round((event.loaded / event.total) * 100);
                            progressBar.style.width = percentComplete + '%';
                            progressText.textContent = `Uploading ${type}... ${percentComplete}%`;
                        }
                    };
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) { resolve(key); }
                        else { reject(new Error(`${type} upload failed.`)); }
                    };
                    xhr.onerror = () => { reject(new Error(`Network error during ${type} upload.`)); };
                    xhr.setRequestHeader('Content-Type', file.type);
                    xhr.send(file);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function handleProfileClick() { /* ... */ }

        document.addEventListener('DOMContentLoaded', () => {
            populateHomeContent();
            showPage('homePage');
        });
    </script>
</body>
</html>
